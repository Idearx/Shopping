ec.pkg("ec.order.proxy");ec.load("ajax");ec.load("ec.box");ec.load("ec.dh");var allProxyCouponCache={};var cache_proxyCoupon_by_inputCode=null;ec.order.proxy.addCouponOnly=function(shopCode){$("#coupon-code-div"+shopCode).hide();$("#couponCodeProxy-report-errors-"+shopCode).removeClass("report-errors").html("");var code=$.trim($("#couponCodeOnly-"+shopCode).val());if(!code||code.length<5||code.length>25){$("#couponCodeProxy-report-errors-"+shopCode).addClass("report-errors").html("请输入正确的优惠券编码");return false}var cCode=[{carrierCode:shopCode,couponCodes:[code]}];ec.order.proxy.addCoupon(JSON.stringify(cCode),{type:"couponcode",shopCode:shopCode,errorFunction:function(msg){if(msg=="order.coupon.used.repeatedly"){msg="优惠券已被使用！"}$("#couponCodeProxy-report-errors-"+shopCode).addClass("report-errors").html(msg);$("#code_use_coupon_btn_"+shopCode).addClass("disabled")},successFunction:function(){$("#code_use_coupon_btn_"+shopCode).removeClass("disabled");ec.order.slideUpIntro()}})};ec.order.proxy.addCoupon=function(code,options){options=options||{};var $form=$("#order-confirm-form");var orderReq=$("input[name=orderReq]",$form).val();(new ec.ajax).submit({url:"/order/coupon/queryProxyCoupon.json",timeout:1e4,data:{couponCode:code,orderReqJson:orderReq},timeoutFunction:function(){ec.order.proxy.ecboxOpen(timeOutInfo)},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(json.success){var cCode=null;try{cCode=JSON.parse(code)}catch(e){cCode={}}if(options.type&&"couponcode"==options.type){ec.order.proxy.couponRender(cCode[0].couponCodes[0],json,options.shopCode);if(options.successFunction){options.successFunction()}}else{if(options.couponData){var couponData=options.couponData.split("|")[0]+"|"+options.couponData.split("|")[1]+"|"+json[options.shopCode].couponDeduct;$("#coupon-first-"+options.shopCode).valS(options.shopCode+"|"+couponData)}ec.order.proxy.showMsg(code,options,json)}}else{var msg=json.msg||"优惠券编码错误。";ec.order.proxy.resetCoupon(options.shopCode);ec.order.proxy.couponNotUse(options.shopCode);if(options.errorFunction){options.errorFunction(msg)}else{if(!options.init)ec.order.proxy.ecboxOpen(msg)}}}});return false};ec.order.proxy.showMsg=function(code,options,json){if(code==null||code==""){$("#proxyCoupon"+options.shopCode).val("");$("#coupon-first-"+options.shopCode).val("");$("#coupon-info-desc-"+options.shopCode).html("");$("#order-price-"+options.shopCode).html(parseFloat(json[options.shopCode].totalPrice).toFixed(2))}else if(options.type&&"coupon"==options.type){var shopCodeKey=options.shopCode;var coupon_info=$("#coupon-first-"+shopCodeKey).val();var infos=coupon_info.split("|");var coupon_info_desc="<span>已选择"+json[shopCodeKey].usedCouponInfos.length+"张券</span>，<b>抵扣&yen<span>"+parseFloat(json[shopCodeKey].couponDeduct).toFixed(2)+"</span></b>";$("#coupon-info-desc-"+options.shopCode).html(coupon_info_desc);$("#order-price-"+infos[0]).html(parseFloat(json[shopCodeKey].totalPrice).toFixed(2));$("#proxyCoupon"+options.shopCode).valS(infos[0]+"|"+infos[1]);var effectiveList=json[shopCodeKey].effectiveList;for(var i=0;i<effectiveList.length;i++){ec.order.couponEnable[effectiveList[i].couponCode]=effectiveList[i].selectable}var codeslists="";for(var i=0;i<json[shopCodeKey].usedCouponInfos.length;i++){codeslists+=","+json[shopCodeKey].usedCouponInfos[i].couponCode;codeslists=ec.order.couponReplace(codeslists)}ec.order.setCouponCodes(shopCodeKey,codeslists)}ec.order.newCount();if(options.successFunction)options.successFunction()};ec.order.proxy.couponRender=function(couponCode,json,shopCode){$("input[id^='coupon-first-']").each(function(){if($(this).val()!=undefined&&$(this).val()!=""){var couponInfo=$(this).val().split("|");if(couponInfo[0]!=shopCode&&couponInfo[1]==couponCode){$("#couponCodeProxy-report-errors-"+shopCode).html("优惠券已被使用！");return}}});if(json[shopCode].effectiveList){var text="";$.each(json[shopCode].effectiveList,function(i,coupon){if(couponCode==coupon.couponCode){var kindCoupon="";var priceLable="";var couponStyle="";if((coupon.ruleType==1||coupon.amount!=null)&&coupon.deliveryFree==0){if(parseInt(coupon.amount)==coupon.amount){kindCoupon="<span>"+parseInt(coupon.amount)+"</span><strong>优惠券</strong>"}else{kindCoupon="<span>"+coupon.amount.toFixed(2)+"</span><strong>优惠券</strong>"}priceLable="<em>&yen;</em>"}else if((coupon.ruleType==2||coupon.discount!=null)&&coupon.deliveryFree==0){couponStyle=" order-roll-discount";kindCoupon="<span>"+coupon.discount*10+"</span><b>折</b>"}else{couponStyle=" order-roll-type";kindCoupon="<span>免邮券</span>"}var couponName=coupon.couponName;var couponAmount=json[shopCode].couponDeduct||0;var msg=[];msg.push('<div class="order-roll-info">');msg.push(priceLable);msg.push('<div class="order-roll-price clearfix">');msg.push(kindCoupon);msg.push("</div>");msg.push('<p title="'+couponName+'" class="order-roll-word">'+ec.autoEncodeAttr(couponName)+"</p>");msg.push("</div>");if(coupon.couponDes!=null){msg.push('<p class="order-roll-explain">使用要求：'+coupon.beginDate.substring(0,10).replaceAll("-",".")+" - "+coupon.endDate.substring(0,10).replaceAll("-",".")+"，"+coupon.couponDes)}else{msg.push('<p class="order-roll-explain">使用要求：'+coupon.beginDate.substring(0,10).replaceAll("-",".")+" - "+coupon.endDate.substring(0,10).replaceAll("-","."))}msg.push('<a href="javascript:;" class="btn"></p>');var coupon=msg.join("");$("#li_coupon-"+shopCode).html(coupon);$("#li_coupon-"+shopCode).removeClass("order-roll-discount");$("#li_coupon-"+shopCode).removeClass("order-roll-type");$("#li_coupon-"+shopCode).addClass(couponStyle);$("#li_coupon-"+shopCode).attr("code",couponCode);var data=couponCode+"|"+couponName+"|"+couponAmount;$("#li_coupon-"+shopCode).attr("data",data);cache_proxyCoupon_by_inputCode={};cache_proxyCoupon_by_inputCode.coupon=coupon;cache_proxyCoupon_by_inputCode.code=couponCode;cache_proxyCoupon_by_inputCode.data=data;cache_proxyCoupon_by_inputCode.couponStyle=couponStyle;allProxyCouponCache[shopCode]=cache_proxyCoupon_by_inputCode;$("#coupon-code-div-"+shopCode).show();return}})}};ec.order.proxy.couponUse=function(thix,shopCode){if($(thix).hasClass("disabled")){return}var couponData="";var cCode=ec.order.tmpCoupons.toArgs(shopCode);ec.order.proxy.addCoupon(cCode,{type:"coupon",shopCode:shopCode,couponData:couponData});$("#coupon-edit-link-"+shopCode).removeClass("hide");$("#coupon-use-link-"+shopCode).addClass("hide");$(".ol_box_mask").addClass("hide");$("#order-coupon-box").addClass("hide")};ec.order.proxy.couponNotUse=function(shopCode){$("#li_coupon-"+shopCode).removeClass("current");allProxyCouponCache[shopCode]=null;$("#coupon-edit-link-"+shopCode).addClass("hide");$("#coupon-use-link-"+shopCode).removeClass("hide");ec.order.proxy.addCoupon("",{shopCode:shopCode,errorFunction:function(){}});$("#usedCouponCodesID_"+shopCode).val("");ec.order.setCouponCodes(shopCode,"");for(var k in ec.order.couponEnable){if(ec.order.couponEnable.hasOwnProperty(k)){if(shopCode===$("#"+k).attr("shopcode-info")){ec.order.couponEnable[k]=true}}}};ec.order.proxy.closeDes=function(){$("#orderCoupontips").hide()};ec.order.proxy.couponTabChange=function(couponTab,shopCode){if(couponTab=="coupon_tab"){$("#coupon_tab_"+shopCode).addClass("current");$("#coupon_tab_"+shopCode+"_2").removeClass("current");$("#coupon_code_tab_"+shopCode).removeClass("current");$("#order-roll-coupon-"+shopCode+">:first").removeClass("hide");$("#order-roll-coupon-"+shopCode+">:gt(0)").removeClass("hide");$("#order-roll-coupon-"+shopCode+"-2>:first").addClass("hide");$("#order-roll-coupon-"+shopCode+"-2>:eq(1)").addClass("hide");$("#order-roll-code-"+shopCode+">:first").addClass("hide");$("#order-roll-code-"+shopCode+">:eq(1)").addClass("hide");if($("li[name^='"+shopCode+"effCouponInfo_']").hasClass("current")){$("#use_coupon_btn_"+shopCode).removeClass("disabled")}else{$("#use_coupon_btn_"+shopCode).addClass("disabled");$("li[name^='"+shopCode+"effCouponInfo_']").removeClass("current")}}else if(couponTab=="coupon_code_tab"){$("#coupon_tab_"+shopCode).removeClass("current");$("#coupon_code_tab_"+shopCode).addClass("current");$("#order-roll-coupon-"+shopCode+">:first").addClass("hide");$("#order-roll-coupon-"+shopCode+">:gt(0)").addClass("hide");$("#order-roll-coupon-"+shopCode+"-2>:first").addClass("hide");$("#order-roll-coupon-"+shopCode+"-2>:eq(1)").addClass("hide");$("#order-roll-code-"+shopCode+">:first").removeClass("hide");$("#order-roll-code-"+shopCode+">:eq(1)").removeClass("hide");$("#coupon_tab_"+shopCode+"_2").removeClass("current")}else{$("#coupon_tab_"+shopCode).removeClass("current");$("#coupon_code_tab_"+shopCode).removeClass("current");$("#coupon_tab_"+shopCode+"_2").addClass("current");$("#order-roll-coupon-"+shopCode+">:first").addClass("hide");$("#order-roll-coupon-"+shopCode+">:gt(0)").addClass("hide");$("#order-roll-coupon-"+shopCode+"-2>:first").removeClass("hide");$("#order-roll-coupon-"+shopCode+"-2>:eq(1)").removeClass("hide");$("#order-roll-code-"+shopCode+">:first").addClass("hide");$("#order-roll-code-"+shopCode+">:eq(1)").addClass("hide");ec.order.slideUpIntro()}};ec.order.proxy.resetCoupon=function(shopCode){$("#proxyCoupon"+shopCode).val("");$("#coupon-first-"+shopCode).val("")};ec.order.proxy.openPopWindow=function(domId,boxId,width,heigth,title,shopCode){var box=new ec.box($("#"+domId).val(),{boxclass:"ol_box_4 ol_box_title",boxid:boxId,title:title,width:width,modal:true,showButton:false,autoHeight:false,height:heigth,onok:function(box){box.close()}}).open();if("order-coupon-tpl-"+shopCode==domId){var couponCode=ec.order.shopCouponCodes(shopCode);if(couponCode.length){if(allProxyCouponCache&&allProxyCouponCache[shopCode]){$("#li_coupon-"+shopCode).addClass("current");$("li[index^='"+shopCode+"effCouponInfo_']").removeClass("current")}}else{$("#code_use_coupon_btn_"+shopCode).unbind("click");$("#code_use_coupon_btn_"+shopCode).addClass("disabled");$("#use_coupon_btn_"+shopCode).unbind("click");$("#use_coupon_btn_"+shopCode).addClass("disabled")}if(allProxyCouponCache&&allProxyCouponCache[shopCode]){$("#li_coupon-"+shopCode).html(allProxyCouponCache[shopCode].coupon);$("#li_coupon-"+shopCode).attr("code",allProxyCouponCache[shopCode].code);$("#li_coupon-"+shopCode).attr("data",allProxyCouponCache[shopCode].data);$("#li_coupon-"+shopCode).removeClass("order-roll-discount");$("#li_coupon-"+shopCode).removeClass("order-roll-type");$("#li_coupon-"+shopCode).addClass(allProxyCouponCache[shopCode].couponStyle);$("#couponCodeOnly-"+shopCode).valS(allProxyCouponCache[shopCode].code);ec.order.proxy.couponTabChange("coupon_code_tab",shopCode);$("#code_use_coupon_btn_"+shopCode).removeClass("disabled");$("#coupon-code-div-"+shopCode).show()}ec.order.slideUpIntro();if(!ec.order.couponCacheShops[shopCode]){$("#order-roll-coupon-"+shopCode+" .order-roll-detail").each(function(){if($(this).attr("id")){ec.order.couponEnable[$(this).attr("id")]=!$(this).hasClass("disabled")}});ec.order.couponCacheShops[shopCode]=true;return false}$("#order-roll-coupon-"+shopCode+" .order-roll-detail").each(function(){if($(this).attr("id")){$(this).removeClass("current").addClass("disabled")}});for(var i=0;i<couponCode.length;i++){$("#"+couponCode[i]).addClass("current").removeClass("disabled")}for(var k in ec.order.couponEnable){if(ec.order.couponEnable.hasOwnProperty(k)){if(ec.order.couponEnable[k]){$("#"+k).removeClass("disabled")}}}ec.order.tmpCoupons.refresh(shopCode)}};ec.order.proxy.couponSelected=function(couponCode,shopCode){if($("#"+couponCode).hasClass("disabled")){$("#toast-"+shopCode).show();setTimeout(function(){$("#toast-"+shopCode).addClass("toast-hide")},1500);setTimeout(function(){$("#toast-"+shopCode).hide().removeClass("toast-hide")},2e3);return false}shopCode=shopCode||$("#"+couponCode).attr("shopCode-info");if($("#"+couponCode).hasClass("current")){ec.order.tmpCoupons.delCode(shopCode,couponCode)}else{ec.order.tmpCoupons.addCode(shopCode,couponCode)}var codeslists=ec.order.tmpCoupons.getCodes(shopCode).join(",");if(codeslists.length<5){$("#"+couponCode).removeClass("current");$("#use_coupon_btn_"+shopCode).addClass("disabled");$("#order-roll-coupon-"+shopCode+" .order-roll-detail.disabled").each(function(){if($(this).attr("id")){$(this).removeClass("disabled")}});return}codeslists=ec.order.couponReplace(codeslists);var orderReqJson=$("#orderReqJsonByCouponID").val();var routingTag=$("#routingTagByCouponID").val();var productId=$("#productIdByCouponID").val();var skuId=$("#skuIdByCouponID").val();var interest=$("#interestByCouponID").val();ec.ui.loading.show({css:{"z-index":9999},maskConfig:{css:{"z-index":9998}}});$.ajax({url:"/order/queryAllUsedCouponList.json",type:"post",dataType:"json",data:{orderReqJson:orderReqJson,routingTag:routingTag,productId:productId,interest:interest,couponCodes:codeslists,shopCode:shopCode,skuId:skuId},timeout:1e4,success:function(json){ec.ui.loading.hide();if(!json.success){var codeArray=codeslists.split(",");for(var i=0;i<codeArray.legnth;i++){$("#"+codeArray[i]).addClass("disabled");$("#"+codeArray[i]).removeClass("current")}alertS(json.msg||"商城火爆销售中，请您稍候再试。");return false}$("#code_use_coupon_btn_"+shopCode).removeClass("disabled");$("#use_coupon_btn_"+shopCode).removeClass("disabled");$("#eff_couponUlId_"+shopCode).find("li").remove();$("#inva_couponUlId_"+shopCode).find("li").remove();var effectiveList=json.cartInfoList[0].effectiveList;var invalidList=json.cartInfoList[0].invalidList;var html="";var html2="";var couponStyle="";var couponKind="";var priceLabel="";if(effectiveList!=null&&effectiveList!=""&&effectiveList!=undefined){for(var i=0;i<effectiveList.length;i++){var effCouponInfo=effectiveList[i];var currentInfo="";var disabledInfo="";if(effCouponInfo.ruleType==1&&effCouponInfo.deliveryFree==0){couponStyle="";couponKind="<span>"+effCouponInfo.amount+"</span><strong>优惠券</strong>";priceLabel="<em>&yen;</em>"}else if(effCouponInfo.ruleType==2&&effCouponInfo.deliveryFree==0){couponStyle=" order-roll-discount";couponKind="<span>"+effCouponInfo.discount*10+"</span><b>折</b>";priceLabel=""}else{couponStyle=" order-roll-type";couponKind="<span>免邮券</span>";priceLabel=""}if(json.cartInfoList[0].usedCouponCodes.indexOf(effCouponInfo.couponCode)!=-1){currentInfo=" current "}if(effCouponInfo.selectable!=true){disabledInfo=" disabled "}html+='<li id="'+effCouponInfo.couponCode+'"  shopCode-info="'+shopCode+'"  name ="'+shopCode+"effCouponInfo_"+(i+1)+'" index="'+shopCode+"effCouponInfo_"+(i+1)+'" data="'+effCouponInfo.couponCode+"|"+effCouponInfo.couponName+"|"+effCouponInfo.amount+'" class="order-roll-detail '+couponStyle+currentInfo+disabledInfo+'" onclick="ec.order.proxy.couponSelected(\''+ec.encodeForJS(effCouponInfo.couponCode)+"','"+ec.encodeForJS(shopCode)+"')\">";html+='<div class="order-roll-info">';html+=priceLabel;html+='<div class="order-roll-price clearfix">';html+=couponKind;html+="</div>";if(effCouponInfo.kind=="2"){html+='<span class="order-roll-tag">叠加劵</span>'}html+='<p title="'+effCouponInfo.couponName+'" class="order-roll-word">'+effCouponInfo.couponName+"</p>";html+="</div>";if(effCouponInfo.couponDes==null){var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html+='<p class="order-roll-explain">使用要求：';html+=des;html+='<a href="javascript:;" class="btn"></a></p>'}else{var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html+='<p class="order-roll-explain">使用要求：';html+=des+"，"+effCouponInfo.couponDes;html+='<a href="javascript:;" class="btn"></a></p>'}}$("#eff_couponUlId_"+shopCode).html(html)}if(invalidList!=null&&invalidList!=""&&invalidList!=undefined){for(var i=0;i<invalidList.length;i++){var effCouponInfo=invalidList[i];if(effCouponInfo.ruleType==1&&effCouponInfo.deliveryFree==0){couponStyle="";couponKind="<span>"+effCouponInfo.amount+"</span><strong>优惠券</strong>";priceLabel="<em>&yen;</em>"}else if(effCouponInfo.ruleType==2&&effCouponInfo.deliveryFree==0){couponStyle=" order-roll-discount";couponKind="<span>"+effCouponInfo.discount*10+"</span><b>折</b>";priceLabel=""}else{couponStyle=" order-roll-type";couponKind="<span>免邮券</span>";priceLabel=""}html2+='<li class="order-roll-detail disabled '+couponStyle+'">';html2+='<div class="order-roll-info">';html2+=priceLabel;html2+='<div class="order-roll-price clearfix">';html2+=couponKind;html2+="</div>";html2+='<p title="'+effCouponInfo.couponName+'" class="order-roll-word">'+effCouponInfo.couponName+"</p>";html2+="</div>";if(effCouponInfo.couponDes==null){var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html2+='<p class="order-roll-explain">使用要求：';html2+=des;html2+='<a href="javascript:;" class="btn"></a></p>'}else{var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html2+='<p class="order-roll-explain">使用要求：';html2+=des+"，"+effCouponInfo.couponDes;html2+='<a href="javascript:;" class="btn"></a></p>'}}}$("#inva_couponUlId_"+shopCode).html(html2);ec.order.slideUpIntro()},error:function(){ec.ui.loading.hide();alert("商城火爆销售中，请您稍候再试。");return false}})};ec.order.proxy.ecboxOpen=function(msg){new ec.box($("#order-confim-box-tpl").val().replace("msg",msg),{boxclass:"ol_box_4",boxid:"show_msg_box",width:700,modal:true,showButton:false,onok:function(box){box.close()}}).open()};