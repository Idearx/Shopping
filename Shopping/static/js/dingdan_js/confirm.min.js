ec.pkg("ec.order");ec.load("ajax");ec.load("ec.box");ec.load("ec.dh");var calledByPointClickEvent=false;ec.ready(function(){ec.dapClick(300040001,{load:1});$("#ec_ui_confirm").click(function(event){event=event||window.event;event.stopPropagation()});$(document).bind("click",function(e){var e=e||window.event;var elem=e.target||e.srcElement;if(elem.innerHTML!="删除"){$("#ec_ui_confirm").hide()}});var _vb=ec.form.validator.bind;if($("#orderType").val()==14||$("#orderType").val()==28||$("#orderType").val()==36||$("#orderType").val()==35){$("#order-address-mod").hide();$("#order-address-hr").hide();$("#peopleTelAddressID").hide()}else{eidtSelectAddressId="";ec.addr.list(ec.order.myAddress.load);$("#address-more .address-expand").click(function(){$("#order-address-list li:not(:last-child)").show();$(".address-expand").hide();$(".address-shrink").show()});$("#address-more .address-shrink").click(function(){if($("li[id^='myAddress'].current").index()>2){$("#order-address-list ul").prepend($("li[id^='myAddress'].current"))}$("#order-address-list li:gt(2)").hide();$(".address-expand").show();$(".address-shrink").hide()})}if($("#orderType").val()!=25&&$("#orderType").val()!=29){if($("#orderType").val()==0||$("#orderType").val()==26||$("#orderType").val()==30||$("#orderType").val()==18){ec.order.point.getOpt()}ec.order.huaban.getOpt()}$("#order-deliveryCharge").text(parseFloat(ec.order.deliveryCharge).toFixed(2));if($("#orderType").val()==36){$("#order-deliveryCharge").text("0.00")}$("#pointShow").hide();$(".discount-integral-main").delegate("li","click",function(){var curObj=$(this);$(".discount-integral-main li").each(function(){$(this).removeClass("selected")});curObj.addClass("selected");$("#pointDefault").text($(curObj.children("a").children("p").children("span").get(0)).text());ec.order.pointConsumed=$("#pointDefault").text();calledByPointClickEvent=true;ec.order.point.confirm()});$(".discount-integral").click(function(e){if($(".discount-integral").hasClass("click")){$(".discount-integral").removeClass("click");$(".discount-integral-con").addClass("hide")}else{$(".discount-integral").addClass("click");$(".discount-integral-con").removeClass("hide")}return false});$("#pointShowMonitor").click(function(e){$(".discount-integral").removeClass("click");$(".discount-integral-con").addClass("hide")})});var orderPromoPremiumsTpl=new ec.template(gid("order-promoPremiums-tpl").value);ec.order.showUsePointArea=function(pointChecked,json){if(pointChecked){ec.order.pointAmount=json.cartInfo.pointPay;ec.order.pointPay=json.cartInfo.pointPay;ec.order.pointConsumed=json.cartInfo.pointConsumed;if(ec.order.pointExpandEnable){var balance=parseFloat(ec.order.pointPay-json.pointExpandPay).toFixed(2);if(json.cartInfo.selectablePointNums!=null&&json.cartInfo.selectablePointNums.length>0){if(!calledByPointClickEvent){$("#pointDefault").textS(json.cartInfo.pointConsumed);var appendHtml=[];for(var i=0;i<json.cartInfo.selectablePointNums.length;i++){if(json.cartInfo.pointConsumed==json.cartInfo.selectablePointNums[i]){appendHtml.push('<li class="selected"><a><p><span>'+json.cartInfo.selectablePointNums[i]+"</span>积分</p></a></li>")}else{appendHtml.push("<li><a><p><span>"+json.cartInfo.selectablePointNums[i]+"</span>积分</p></a></li>")}}$("#pointShow").find("ul").html(appendHtml.join(""))}calledByPointClickEvent=false;$("#pointUsePlan").html("积分抵<span>&yen;"+balance+"</span>，"+json.pointPromoLabel+"抵<span>&yen;"+parseFloat(json.pointExpandPay).toFixed(2)+'</span>，共抵<b class="red">&yen;'+parseFloat(ec.order.pointPay).toFixed(2)+"</b>");$("#pointShow").show();$("#canUserPoint").hide()}else{if(json.pointExpandPay>0){$("#canUserPoint").removeClass("red").html('，使用<span id="point-max">'+ec.order.pointConsumed+"</span>积分抵¥"+balance+"，"+json.pointPromoLabel+"抵¥"+parseFloat(json.pointExpandPay).toFixed(2)+"，共抵<b>¥"+parseFloat(ec.order.pointPay).toFixed(2)+"</b>")}else{$("#canUserPoint").removeClass("red").html('，使用<span id="point-max">'+ec.order.pointConsumed+"</span>积分"+"，抵<b>¥"+parseFloat(ec.order.pointPay).toFixed(2)+"</b>")}$("#pointShow").hide();$("#canUserPoint").show()}}else{$("#canUserPoint").removeClass("red").html('，使用<span id="point-max">'+ec.order.pointConsumed+'</span>积分，抵<b id="point-plus">¥'+parseFloat(ec.order.pointPay).toFixed(2)+"</b>");$("#pointShow").hide();$("#canUserPoint").show()}}else{var point_blance=parseInt($("#point-count").html());if(json.pointExpandEnable&&json.pointGuideWord!=null&&json.pointGuideWord!=""){$("#canUserPoint").addClass("red").html("<span style='color: #3a3a3a;'>，</span>"+json.pointGuideWord)}else if(point_blance<100){$("#canUserPoint").removeClass("red").html("，不足100不可使用")}else{$("#canUserPoint").removeClass("red").html("")}ec.order.pointAmount=0;$("#pointShow").hide();$("#canUserPoint").show()}};ec.order.computeDelieryFee=function(){if($("#orderType").val()==10){return}var state=$("#order-state").val()||0;var $form=$("#order-confirm-form");var orderReq=$("input[name=orderReq]",$form).val();var UIDesignID=$("input[name=UIDesignID]",$form).val();var sbs=$("input[name=sbs]",$form).val();var types=$("input[name=types]",$form).val();var qtys=$("input[name=qtys]",$form).val();var css=$("input[name=css]",$form).val();var ess=$("input[name=ess]",$form).val();var ass=$("input[name=ass]",$form).val();var usePetalEnable=$("#usePetalFlag").val();var usePointEnable=$("#usePointFlag").val();var code=$("#order-couponCode").val();var regionId=ec.order.getSelectAddress2();var data,url;var point_checked=$("#point-checkbox").prop("checked");if($("#orderType").val()==25){data={UIDesignID:UIDesignID,sbs:sbs,qtys:qtys,css:css,ess:ess,ass:ass,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,couponCode:code,regionId:regionId,sourceType:1};url="/order/queryPetalAndPoint4Made.json"}else if($("#orderType").val()==18){data={couponCode:code,orderReqJson:orderReq,regionId:regionId,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,usingPointNum:point_checked?$("#pointDefault").text():0};url="/order/coupon/queryDepositInfo.json"}else{data={couponCode:code,state:state,orderReqJson:orderReq,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,regionId:regionId,routingTag:$("#orderType").val(),usingPointNum:point_checked?$("#pointDefault").text():0};url="/order/coupon/queryInfobycart.json"}if(url!=null&&data!=null){(new ec.ajax).submit({url:url,timeout:1e4,data:data,timeoutFunction:function(){ec.order.ecboxOpen(timeOutInfo)},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(!json.success){ec.showError(json);return}if(json.deliveryFree=="1"){$("#order-deliveryCharge").text("0.00");ec.order.deliveryCharge=0;ec.order.newCount()}else{$("#order-deliveryCharge").text(parseFloat(json.cartInfo.deliveryFreeAmount).toFixed(2));ec.order.deliveryCharge=parseFloat(json.cartInfo.deliveryFreeAmount);ec.order.newCount()}}})}};ec.order.addCoupon2=function(shopCode){$("#coupon-code-div").hide();$("#couponCode2-report-errors").removeClass("report-errors").html("");var code=$.trim($("#couponCode2").val());if(!code||code.length<5||code.length>25){$("#couponCode2-report-errors").addClass("report-errors").html("请输入正确的优惠券编码");return false}var couponCode=[{carrierCode:shopCode,couponCodes:[code]}];ec.order.addCoupon(JSON.stringify(couponCode),{errorFunction:function(msg){ec.order.tmpCoupons.cls(shopCode);$("#eff_couponUlId_"+shopCode).find("li").removeClass("disabled");$("#couponCode2-report-errors").addClass("report-errors").html(msg);$("#code_use_coupon_btn").addClass("disabled")},successFunction:function(){$("#code_use_coupon_btn").removeClass("disabled");ec.order.slideUpIntro()},type:"couponcode"},shopCode)};ec.order.slideUpIntro=function(){$(".order-roll-explain").each(function(){if($(this).height()>18){$(this).addClass("order-roll-explain-more");$(this).children("a").removeClass("hide");$(this).unbind("click").bind("click",function(){if($(this).attr("class").indexOf("order-roll-explain-open")==-1){$(this).addClass("order-roll-explain-open")}else{$(this).removeClass("order-roll-explain-open")}return false})}})};ec.order.closeDes=function(){$("#orderCoupontips").hide()};ec.order.addCoupon=function(code,options,shopCode){var state=$("#order-state").val()||0;options=options||{};var $form=$("#order-confirm-form");var orderReq=$("input[name=orderReq]",$form).val();var UIDesignID=$("input[name=UIDesignID]",$form).val();var sbs=$("input[name=sbs]",$form).val();var types=$("input[name=types]",$form).val();var qtys=$("input[name=qtys]",$form).val();var css=$("input[name=css]",$form).val();var ess=$("input[name=ess]",$form).val();var ass=$("input[name=ass]",$form).val();var usePetalEnable=$("#usePetalFlag").val();var usePointEnable=$("#usePointFlag").val();var regionId=ec.order.getSelectAddress2();var data,url;var point_checked=$("#point-checkbox").prop("checked");if($("#orderType").val()==25){data={UIDesignID:UIDesignID,sbs:sbs,qtys:qtys,css:css,ess:ess,ass:ass,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,couponCode:code,regionId:regionId,sourceType:1};url="/order/queryPetalAndPoint4Made.json"}else if($("#orderType").val()==18){data={couponCode:code,orderReqJson:orderReq,regionId:regionId,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,usingPointNum:point_checked?$("#pointDefault").text():0};url="/order/coupon/queryDepositInfo.json"}else{data={shopCode:shopCode,couponCode:code,state:state,orderReqJson:orderReq,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,regionId:regionId,routingTag:$("#orderType").val(),usingPointNum:point_checked?$("#pointDefault").text():0};url="/order/coupon/queryInfobycart.json"}if(url!=null&&data!=null){(new ec.ajax).submit({url:url,timeout:1e4,data:data,timeoutFunction:function(){ec.order.ecboxOpen(timeOutInfo)},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(json.success){ec.order.commonPoint(json);if(options.type&&"couponcode"==options.type){if(json.cartInfo.usedCouponInfo==null){return}var codes=JSON.parse(code);ec.order.couponRender(codes[0].couponCodes[0],json);if(options.successFunction)options.successFunction()}else{ec.order.showMsg(code,options,json)}ec.order.showUsePointArea(point_checked,json)}else{var msg=json.msg||"优惠券编码错误。";ec.order.couponNotUse(shopCode);if(options.errorFunction){options.errorFunction(msg)}else{if(!options.couponInit)ec.order.ecboxOpen(msg)}}}})}return false};ec.order.showMsg=function(code,options,json){var cartInfo4Add=json.cartInfo;var couponDeduct=parseFloat(json.couponDeduct).toFixed(2);var orderType=$("#orderType").val();if(orderType==18){if(couponDeduct>ec.order.balancePrice){couponDeduct=ec.order.balancePrice}if(null!=cartInfo4Add.balanceAmount){$("#balanceAmountIDD").html(cartInfo4Add.balanceAmount.toFixed(2))}}$("#order-couponDiscount").html(couponDeduct);$("#couponSelfDeduct").html("-&yen;<em>"+couponDeduct+"</em>");ec.order.couponDiscount=json.couponDeduct;if(options.type&&"coupon"==options.type){var coupon_info=$("#couponInfo").val();var infos=coupon_info.split("|");var coupon_info_desc='<span id="coupon-info-amount">已选择'+json.cartInfo.usedCouponInfos.length+'张券</span>，<b id="b_yuan">抵扣&yen<span id="coupon-info-discount">'+parseFloat(json.couponDeduct).toFixed(2)+"</span></b>";$("#coupon-info-desc").html(coupon_info_desc);var effectiveList=json.cartInfo.effectiveList;for(var i=0;i<effectiveList.length;i++){ec.order.couponEnable[effectiveList[i].couponCode]=effectiveList[i].selectable}var codeslists="";for(var i=0;i<json.cartInfo.usedCouponInfos.length;i++){codeslists+=","+json.cartInfo.usedCouponInfos[i].couponCode;codeslists=ec.order.couponReplace(codeslists)}ec.order.setCouponCodes(json.cartInfo.shopCode,codeslists);if(infos[0]==0){ec.order.computeDelieryFee()}else{$("#order-deliveryCharge").html("0.00");ec.order.deliveryCharge=0;ec.order.newCount()}}if(options.type&&"couponNotuse"==options.type){ec.order.newCount()}if(json.cartInfo.pointGift==null||json.cartInfo.pointGift==""||json.cartInfo.pointGift==0){$("#isHidePoint").hide();$("#canHavePoint").html("")}else{$("#isHidePoint").show();$("#canHavePoint").html(json.cartInfo.pointGift)}if(options.successFunction){options.successFunction()}};ec.order.couponRender=function(couponCode,json){if(json.cartInfo.effectiveList){var text="";$.each(json.cartInfo.effectiveList,function(i,coupon){if(couponCode==coupon.couponCode){var kindCoupon="";var priceLable="";var couponStyle="";if((coupon.ruleType==1||coupon.amount!=null)&&coupon.deliveryFree==0){if(parseInt(coupon.amount)==coupon.amount){kindCoupon="<span>"+parseInt(coupon.amount)+"</span><strong>优惠券</strong>"}else{kindCoupon="<span>"+coupon.amount.toFixed(2)+"</span><strong>优惠券</strong>"}priceLable="<em>&yen;</em>"}else if((coupon.ruleType==2||coupon.discount!=null)&&coupon.deliveryFree==0){couponStyle=" order-roll-discount";kindCoupon="<span>"+coupon.discount*10+"</span><b>折</b>"}else{couponStyle=" order-roll-type";kindCoupon="<span>免邮券</span>"}var couponName=coupon.couponName;var couponAmount=coupon.amount||0;var deliveryFree=coupon.deliveryFree;var msg=[];msg.push('<div class="order-roll-info">');msg.push(priceLable);msg.push('<div class="order-roll-price clearfix">');msg.push(kindCoupon);msg.push("</div>");msg.push('<p title="'+ec.autoEncodeAttr(couponName)+'" class="order-roll-word">'+ec.autoEncodeAttr(couponName)+"</p>");msg.push("</div>");if(coupon.couponDes!=null){msg.push('<p class="order-roll-explain">使用要求：'+coupon.beginDate.substring(0,10).replaceAll("-",".")+" - "+coupon.endDate.substring(0,10).replaceAll("-",".")+"，"+coupon.couponDes)}else{msg.push('<p class="order-roll-explain">使用要求：'+coupon.beginDate.substring(0,10).replaceAll("-",".")+" - "+coupon.endDate.substring(0,10).replaceAll("-","."))}msg.push('<a href="javascript:;" class="btn"></a> </p>');var coupon=msg.join("");$("#li_coupon").html(coupon);$("#li_coupon").removeClass("order-roll-discount");$("#li_coupon").removeClass("order-roll-type");$("#li_coupon").addClass(couponStyle);$("#li_coupon").attr("code",couponCode);var data=deliveryFree+"|"+couponCode+"|"+couponName+"|"+couponAmount;$("#li_coupon").attr("data",data);cache_coupon_by_inputCode={};cache_coupon_by_inputCode.coupon=coupon;cache_coupon_by_inputCode.code=couponCode;cache_coupon_by_inputCode.data=data;cache_coupon_by_inputCode.couponStyle=couponStyle;cache_coupon_by_inputCode.shopCode=json.cartInfo.shopCode;$("#coupon-code-div").show();return}})}};ec.order.tmpCoupons={data:{},getCodes:function(shopCode){if(!this.data[shopCode]){this.data[shopCode]=ec.order.shopCouponCodes(shopCode)}return this.data[shopCode]},hasCode:function(shopCode,code){return this.getCodes(shopCode).indexOf(code)>-1},addCode:function(shopCode,code){if(this.getCodes(shopCode).indexOf(code)<0){this.data[shopCode].push(code)}return this.data[shopCode]},delCode:function(shopCode,code){var i=this.getCodes(shopCode).indexOf(code);if(i>-1){this.data[shopCode].splice(i,1)}return this.data[shopCode]},cls:function(shopCode){this.data[shopCode]=false},refresh:function(shopCode){if(this.data[shopCode]&&this.data[shopCode].length>0){var _self=this;this.data[shopCode].forEach(function(code){if(!$("#"+code).hasClass("current")){_self.delCode(shopCode,code)}})}},toArgs:function(shopCode){var codes=this.getCodes(shopCode);if(codes.length>0){return JSON.stringify([{carrierCode:shopCode,couponCodes:codes}])}else{return""}}};ec.order.couponUse=function(thix,shopCode){if($(thix).hasClass("disabled")){return}var couponCode="";var couponData="";if($("#coupon_tab").attr("class")=="current"){cache_coupon_by_inputCode=null;$("#order-roll-coupon li.order-roll-detail.current").each(function(){couponCode+=",";couponCode+=$(this).attr("id");couponData+=",";couponData+=$(this).attr("data")});couponCode=ec.order.tmpCoupons.toArgs(shopCode);couponData=couponData.substring(1)}else{$("li[index^='effCouponInfo_']").removeClass("current");couponCode=JSON.stringify([{carrierCode:cache_coupon_by_inputCode.shopCode,couponCodes:[cache_coupon_by_inputCode.code]}]);couponData=$("#li_coupon").attr("data")}$("#couponInfo").valS(couponData);ec.order.addCoupon(couponCode,{type:"coupon"},shopCode);$("#coupon-edit-link").removeClass("hide");$("#coupon-use-link").addClass("hide");$(".ol_box_mask").addClass("hide");$("#order-coupon-box").addClass("hide")};ec.order.couponNotUse=function(shopCode){$("li[name^='effCouponInfo_']").removeClass("current");$("#li_coupon").removeClass("current");cache_coupon_by_inputCode=null;$("#couponInfo").val("");ec.order.addCoupon("",{type:"couponNotuse"});ec.order.setCouponCodes(shopCode,"");ec.order.couponDiscount=0;ec.order.computeDelieryFee();$("#coupon-info-desc").html("");$("#coupon-edit-link").addClass("hide");$("#coupon-use-link").removeClass("hide");$("#use_coupon_btn").addClass("disabled");for(var k in ec.order.couponEnable){if(ec.order.couponEnable.hasOwnProperty(k)){if(shopCode===$("#"+k).attr("shopcode-info")){ec.order.couponEnable[k]=true}}}};ec.order.submit=function(){if($("#checkoutSubmit").hasClass("disabled")){return false}if(ec.order.pointConsumed){var fromItem=$("<input name='usingPointNum' type='hidden' value='"+ec.order.pointConsumed+"'/>");$("#order-confirm-form").append(fromItem)}pushPostOrderMsg();var shopCodeList=$("#order-shopCodes").val().split("|");for(var i=0;i<shopCodeList.length;i++){if(!shopCodeList[i]==""){if($("#order-titleType"+shopCodeList[i]).val()=="3"){var titleSpecial=$("#order-vatInvoiceCompany"+shopCodeList[i]).val();if(!ec.order.companyValidator(titleSpecial)){$("#erroCompany").html("");var tempEorrorTips=[];tempEorrorTips.push('<div class="box-errors-1"><span>发票抬头限制不能为'+ec.autoEncodeAttr(titleSpecial)+"，请重新填写</span></div>");tempEorrorTips.push('<div class="box-button">  <a href="javascript:;" class="box-ok"><span>确定</span></a> </div>');$("#erroCompany").html(tempEorrorTips.join(""));ec.order.errorCompanyBox();return}}else{var title=$("#order-invoiceTitle"+shopCodeList[i]).val();if(!ec.order.companyValidator(title)){$("#erroCompany").html("");var tempEorrorTips=[];tempEorrorTips.push('<div class="box-errors-1"><span>发票抬头限制不能为'+ec.autoEncodeAttr(title)+"，请重新填写</span></div>");tempEorrorTips.push('<div class="box-button">  <a href="javascript:;" class="box-ok"><span>确定</span></a> </div>');$("#erroCompany").html(tempEorrorTips.join(""));ec.order.errorCompanyBox();return}}}}if(28==$("#orderType").val()||14==$("#orderType").val()||$("#orderType").val()==36||$("#orderType").val()==35){ec.order.submitHua();return}if($("#order-address-list li").length==1){ec.order.noAddressBox();return false}if($("#order-address-list li.current").length==0){ec.order.addressNullTips();return false}noInvoice=false;noInvoicePos=1e6;$(".invoiceEdit").each(function(){if($(this).text()=="选择发票类型"){var pos=$(this).offset().top-100;noInvoicePos=pos<noInvoicePos?pos:noInvoicePos;noInvoice=true}});if(noInvoice){ec.order.globalNullTips("请选择发票",function(){$("html,body").animate({scrollTop:noInvoicePos},100)});return}for(var i=0;i<shopCodeList.length;i++){if(shopCodeList[i]!=""&&shopCodeList[i]!="VMALL-HUAWEIDEVICE"){if(document.getElementById("order-invoice-edit")==null){UIController.initBoxForDirectCommit(shopCodeList[i])}var invoiceConfig=InvoiceManager.invoiceCfgList[shopCodeList[i]];var cachedInvoice=InvoiceManager.getInvoice(shopCodeList[i]);if(cachedInvoice.lastInvoiceType=="2"){var invoiceTitle=document.getElementById("invoice-info-title"+shopCodeList[i]).innerHTML;if(invoiceConfig&&invoiceConfig.isRequirePhoneCheck){if(invoiceTitle=="个人"){if($("#invoice-electronic-person-phone").val()==""){ec.order.ecboxOpen("请输入电子普通发票的接收手机");return}}else{if($("#invoice-electronic-unit-phone").val()==""){ec.order.ecboxOpen("请输入电子普通发票的接收手机");return}}}else if(invoiceConfig&&invoiceConfig.isRequireEmailCheck){if(invoiceTitle=="个人"){if($("#invoice-electronic-email-person").val()==""){ec.order.ecboxOpen("请输入电子普通发票的接收邮箱");return}}else{if($("#invoice-electronic-email-unit").val()==""){ec.order.ecboxOpen("请输入电子普通发票的接收邮箱");return}}}}}}var needL4Addr=$("#order-address-list li.current").find("#needL4Addr").val();var needModify=$("#order-address-list li.current").find("#needModify").val();if(needModify=="true"){ec.order.ecboxOpen("您的收货地址有误,请修改收货地址再试！");return}if(needL4Addr=="true"){ec.order.ecboxOpen("为确保商品尽快送达，请补充街道信息。");return}var currentAddressId=$("#order-address-list li.current input[name='myAddress']").val();$("#order-confirm-form>#order-address").valS(currentAddressId);if($("#orderType").val()=="30"){$("#giftMessage").val("");if($("#giftMessageTip").length>0){$("#giftMessage").val($("#giftMessageTip").val())}if($("#orderType").val()==30&&$("#giftMessageTip").val()!=null&&$("#giftMessageTip").val()!=""){var pattern=/[^A-Za-z0-9。.？?！!，,、；;：:“”‘’（ ）\[\]{}()─•．《》〈〉<>—_*×□\/▲●～~…→@#￥%&—\-=\s\r\n\u4e00-\u9fa5]/;if(pattern.test($("#giftMessageTip").val())){ec.order.ecboxOpen("祝贺语存在非法字符，请修改！");return}else if($("#giftMessageTip").val().split("\n").length>6){ec.order.ecboxOpen("祝贺语最多允许6行文字，请修改！");return}}}ec.order.taxNumber()};ec.order.submitHua=function(){noInvoice=false;noInvoicePos=1e6;$(".invoiceEdit").each(function(){if($(this).text()=="选择发票类型"){var pos=$(this).offset().top-100;noInvoicePos=pos<noInvoicePos?pos:noInvoicePos;noInvoice=true}});if(noInvoice){ec.order.globalNullTips("请选择发票",function(){$("html,body").animate({scrollTop:noInvoicePos},100)});return}ec.order.invalidSubmitProduct()};var _huaban_tips=false;var _point_tips=false;ec.order.tips=function(){if(_huaban_tips||_point_tips)$("#order-discount-tip").show();else $("#order-discount-tip").hide()};ec.order.huaban={toggle:function(){if(parseInt(ec.order.petalValidPetalTotal)<ec.order.huabanLowestUsage){$("#usePetalFlag").val("false");ec.order.petalAmount=0;$("#huaban_des").html("花瓣余额&nbsp;"+ec.order.petalValidPetalTotal);$("#canUserPetal").html("，不足"+ec.order.huabanLowestUsage+"不可使用");$("#huaban-checkbox").attr("class","icon-choose-normal icon-choose-disabled");return}var isCheck=$("#huaban-checkbox").attr("checked");if(!isCheck){isCheck=true;$("#huaban_des").html("花瓣余额&nbsp;"+ec.order.petalValidPetalTotal);$("#huaban-checkbox").prop("checked",true);$("#huaban-checkbox").attr("class","icon-choose-normal icon-choose")}else{isCheck=false;$("#huaban_des").html("使用花瓣");$("#canUserPetal").html("");$("#huaban-checkbox").prop("checked",false);$("#huaban-checkbox").attr("class","icon-choose-normal")}if(isCheck){$("#usePetalFlag").val("true")}else{$("#usePetalFlag").val("false")}if($("#orderType").val()==25){this.confirm4Made()}else{this.confirm()}},getOpt:function(fn){var deliveryCharge=null;if(null==$("#order-deliveryCharge").html()){deliveryCharge=0}else{deliveryCharge=parseFloat($("#order-deliveryCharge").html().replace("¥","").replace("&nbsp;",""),10)}(new ec.ajax).get({url:"/query/petal/info.json",data:{orderPrice:parseFloat(ec.order.petalFlagTotalPrice,10)-deliveryCharge},timeout:1e4,timeoutFunction:function(){},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(!json.success){return}json.validPetalTotal=parseInt(json.validPetalTotal,10);if(json.validPetalTotal>0){ec.order.petalValidPetalTotal=json.validPetalTotal}if(parseInt(ec.order.petalValidPetalTotal)<ec.order.huabanLowestUsage){$("#usePetalFlag").val("false");ec.order.petalAmount=0;$("#huaban_des").html("花瓣余额&nbsp;"+ec.order.petalValidPetalTotal);$("#canUserPetal").html("，不足"+ec.order.huabanLowestUsage+"不可使用");$("#huaban-checkbox").attr("class","icon-choose-normal icon-choose-disabled");return}if(fn&&ec.util.isFunction(fn))fn.call(ec.order.huaban)}})},confirm:function(json){var state=$("#order-state").val()||0;var $form=$("#order-confirm-form");var sbs=$("input[name=sbs]",$form).val();var types=$("input[name=types]",$form).val();var qtys=$("input[name=qtys]",$form).val();var ess=$("input[name=ess]",$form).val();var ass=$("input[name=ass]",$form).val();var orderReq=$("input[name=orderReq]",$form).val();var usePetalEnable=$("#usePetalFlag").val();var usePointEnable=$("#usePointFlag").val();var code=$("#order-couponCode").val();var regionId=ec.order.getSelectAddress2();var point_checked=$("#point-checkbox").prop("checked");var data={state:state,orderReq:orderReq,sbs:sbs,types:types,qtys:qtys,ess:ess,ass:ass,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,couponCode:code,regionId:regionId,routingTag:$("#orderType").val(),usingPointNum:point_checked?$("#pointDefault").text():0};(new ec.ajax).submit({url:"/order/queryPetalAndPoint.json",timeout:1e4,data:data,timeoutFunction:function(){ec.order.ecboxOpen(timeOutInfo)},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(!json.success){var isCheck=$("#huaban-checkbox").attr("checked");if(!isCheck){$("#huaban-checkbox").prop("checked",true);$("#huaban-checkbox").addClass("icon-choose").removeClass("icon-choose-disabled")}else{$("#huaban-checkbox").prop("checked",false);$("#huaban-checkbox").removeClass("icon-choose").removeClass("icon-choose-disabled")}ec.order.ecboxOpen(json.msg);return}ec.order.huaban.showMsg(json);ec.order.tips()}})},confirm4Made:function(json){var $form=$("#order-confirm-form");var UIDesignID=$("input[name=UIDesignID]",$form).val();var sbs=$("input[name=sbs]",$form).val();var qtys=$("input[name=qtys]",$form).val();var css=$("input[name=css]",$form).val();var ess=$("input[name=ess]",$form).val();var ass=$("input[name=ass]",$form).val();var usePetalEnable=$("#usePetalFlag").val();var usePointEnable=$("#usePointFlag").val();var code=$("#order-couponCode").val();var regionId=ec.order.getSelectAddress2();var data={UIDesignID:UIDesignID,sbs:sbs,qtys:qtys,css:css,ess:ess,ass:ass,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,couponCode:code,regionId:regionId,sourceType:0};(new ec.ajax).submit({url:"/order/queryPetalAndPoint4Made.json",timeout:1e4,data:data,timeoutFunction:function(){ec.order.ecboxOpen(timeOutInfo)},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(!json.success){var isCheck=$("#huaban-checkbox").attr("checked");if(!isCheck){$("#huaban-checkbox").prop("checked",true);$("#huaban-checkbox").addClass("icon-choose").removeClass("icon-choose-disabled")}else{$("#huaban-checkbox").prop("checked",false);$("#huaban-checkbox").removeClass("icon-choose").removeClass("icon-choose-disabled")}ec.order.ecboxOpen(json.msg);return}ec.order.huaban.showMsg(json)}})},reset:function(){var $price=$("#order-price");$price.text($price.attr("data-oldval"));$("#oreder-huaban-num").html("0.00");ec.order.petalAmount=0;ec.order.newCount()},showMsg:function(json){ec.order.petalPay=json.cartInfo.petalPay;ec.order.pointPay=json.cartInfo.pointPay;ec.order.pointConsumed=json.cartInfo.pointConsumed;ec.order.petalNum=json.cartInfo.petalNum;var huaban_checked=$("#huaban-checkbox").prop("checked");var point_checked=$("#point-checkbox").prop("checked");var point_enable=$("#point-checkbox").attr("onclick");var point_blance=parseInt($("#point-count").html());if(point_blance!=ec.order.pointConsumed&&ec.order.pointConsumed!=0){_point_tips=true}else{_point_tips=false}if(ec.order.petalNum!=ec.order.petalValidPetalTotal&&ec.order.petalNum!=0){if(ec.order.petalValidPetalTotal>0)_huaban_tips=true}else{_huaban_tips=false}if(huaban_checked){ec.order.petalAmount=json.cartInfo.petalPay;$("#canUserPetal").html('，使用<span id="huaban-max">'+ec.order.petalNum+'</span>花瓣，抵<b id="point-plus">¥'+parseFloat(ec.order.petalPay).toFixed(2)+"</b>")}else{ec.order.petalAmount=0}ec.order.showUsePointArea(point_checked,json);if(json.cartInfo.pointGift==null||json.cartInfo.pointGift==""||json.cartInfo.pointGift==0){$("#isHidePoint").hide();$("#canHavePoint").html("")}else{$("#isHidePoint").show();$("#canHavePoint").html(json.cartInfo.pointGift)}ec.order.huaban.count()},count:function(json){var pointDiscount=ec.order.pointAmount;var petalDiscount=ec.order.petalAmount;var $discountTotalPrice=$("#order-discountTotalPrice");var couponDiscount=parseFloat($("#order-couponDiscount").html(),10);$discountTotalPrice.text((parseFloat($discountTotalPrice.attr("data-oldVal"),10)+petalDiscount+pointDiscount+couponDiscount).toFixed(2));$("#oreder-huaban-num").text(petalDiscount.toFixed(2));$("#oreder-point-num").text(pointDiscount.toFixed(2));ec.order.newCount()}};ec.order.point={toggle:function(){var isCheck=$("#point-checkbox").attr("checked");if(!isCheck){isCheck=true;$("#point-checkbox").prop("checked",true);$("#point-checkbox").attr("class","icon-choose-normal icon-choose")}else{isCheck=false;$("#point-checkbox").prop("checked",false);$("#point-checkbox").attr("class","icon-choose-normal");if(ec.order.pointExpandEnable&&ec.order.pointGuideWord!=null&&ec.order.pointGuideWord!=""){$("#canUserPoint").addClass("red").html("<span style='color: #3a3a3a;'>，</span>"+ec.order.pointGuideWord)}else{$("#canUserPoint").removeClass("red").html("")}}if(isCheck){$("#usePointFlag").val("true")}else{$("#usePointFlag").val("false")}if($("#orderType").val()==25){this.confirm4Made()}else{this.confirm()}},getOpt:function(fn){var $pointCount=$("#point-count");$.ajax({url:openApiDomain+"/point/queryUserPointBalanceDetail.json",dataType:"json",data:{ifHisDetail:"0"},timeout:1e4,beforeSend:function(xhr){xhr.withCredentials=true},success:function(json){if(json.resultCode!="200000"){$("#point-checkbox").removeClass("icon-choose").addClass("icon-choose-disabled");return}json=json.data;var point_blance=json.pointBlance;if(point_blance>=100){if(json.status=="S"){$("#point-checkbox").removeClass("icon-choose").addClass("icon-choose-disabled");$pointCount.html(point_blance+"<span>（已冻结）</span>");$("#point-checkbox").unbind("click")}else{$("#point-checkbox").removeClass("icon-choose").removeClass("icon-choose-disabled");$pointCount.html(point_blance);if(ec.order.pointExpandEnable&&ec.order.pointGuideWord!=null&&ec.order.pointGuideWord!=""){$("#canUserPoint").addClass("red").html("<span style='color: #3a3a3a;'>，</span>"+ec.order.pointGuideWord)}$("#point-checkbox").bind("click",function(){ec.order.point.toggle()})}}else{$("#canUserPoint").removeClass("red").html("，不足100不可使用");$("#point-checkbox").unbind("click");$("#point-checkbox").removeClass("icon-choose").addClass("icon-choose-disabled");if(json.status=="S"){$pointCount.html(point_blance+"<span>（已冻结）</span>")}else{$pointCount.html(point_blance)}}if(fn&&ec.util.isFunction(fn))fn.call(ec.order.point)}})},confirm:function(json){var state=$("#order-state").val()||0;var $form=$("#order-confirm-form");var sbs=$("input[name=sbs]",$form).val();var types=$("input[name=types]",$form).val();var qtys=$("input[name=qtys]",$form).val();var ess=$("input[name=ess]",$form).val();var orderReq=$("input[name=orderReq]",$form).val();var ass=$("input[name=ass]",$form).val();var usePetalEnable=$("#usePetalFlag").val();var usePointEnable=$("#usePointFlag").val();var code=$("#order-couponCode").val();var regionId=ec.order.getSelectAddress2();var point_checked=$("#point-checkbox").prop("checked");var data={state:state,orderReq:orderReq,sbs:sbs,types:types,qtys:qtys,ess:ess,ass:ass,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,couponCode:code,regionId:regionId,routingTag:$("#orderType").val(),usingPointNum:point_checked?$("#pointDefault").text():0};(new ec.ajax).submit({url:"/order/queryPetalAndPoint.json",timeout:1e4,data:data,timeoutFunction:function(){},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(!json.success){var isCheck=$("#point-checkbox").attr("checked");if(!isCheck){$("#point-checkbox").prop("checked",true);$("#point-checkbox").addClass("icon-choose").removeClass("icon-choose-disabled")}else{$("#point-checkbox").prop("checked",false);$("#point-checkbox").removeClass("icon-choose").removeClass("icon-choose-disabled")}ec.order.ecboxOpen(json.msg);return}ec.order.point.showMsg(json);ec.order.tips()}})},confirm4Made:function(json){var $form=$("#order-confirm-form");var UIDesignID=$("input[name=UIDesignID]",$form).val();var sbs=$("input[name=sbs]",$form).val();var qtys=$("input[name=qtys]",$form).val();var css=$("input[name=css]",$form).val();var ess=$("input[name=ess]",$form).val();var ass=$("input[name=ass]",$form).val();var usePetalEnable=$("#usePetalFlag").val();var usePointEnable=$("#usePointFlag").val();var code=$("#order-couponCode").val();var regionId=ec.order.getSelectAddress2();var data={UIDesignID:UIDesignID,sbs:sbs,qtys:qtys,css:css,ess:ess,ass:ass,usePetalEnable:usePetalEnable,usePointEnable:usePointEnable,couponCode:code,regionId:regionId,sourceType:0};(new ec.ajax).submit({url:"/order/queryPetalAndPoint4Made.json",timeout:1e4,data:data,timeoutFunction:function(){},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(!json.success){var isCheck=$("#point-checkbox").attr("checked");if(!isCheck){$("#point-checkbox").prop("checked",true);$("#point-checkbox").addClass("icon-choose").removeClass("icon-choose-disabled")}else{$("#point-checkbox").prop("checked",false);$("#point-checkbox").removeClass("icon-choose").removeClass("icon-choose-disabled")}ec.order.ecboxOpen(json.msg);return}ec.order.point.showMsg(json)}})},reset:function(){var $price=$("#order-price");$price.text($price.attr("data-oldval"));$("#oreder-point-num").text("0.00");ec.order.pointAmount=0;ec.order.newCount()},showMsg:function(json){ec.order.petalPay=json.cartInfo.petalPay;ec.order.pointPay=json.cartInfo.pointPay;ec.order.pointConsumed=json.cartInfo.pointConsumed;ec.order.petalNum=json.cartInfo.petalNum;var point_blance=parseInt($("#point-count").html());if(point_blance!=ec.order.pointConsumed&&ec.order.pointConsumed!=0){_point_tips=true}else{_point_tips=false}if(ec.order.petalNum!=ec.order.petalValidPetalTotal&&ec.order.petalNum!=0){if(ec.order.petalValidPetalTotal>0)_huaban_tips=true}else{_huaban_tips=false}var huaban_checked=$("#huaban-checkbox").prop("checked");if(huaban_checked){ec.order.petalAmount=json.cartInfo.petalPay;$("#canUserPetal").html('，使用<span id="huaban-max">'+ec.order.petalNum+'</span>花瓣，抵<b id="point-plus">¥'+parseFloat(ec.order.petalPay).toFixed(2)+"</b>")}var point_checked=$("#point-checkbox").prop("checked");ec.order.showUsePointArea(point_checked,json);if(json.cartInfo.pointGift==null||json.cartInfo.pointGift==""||json.cartInfo.pointGift==0){$("#isHidePoint").hide();$("#canHavePoint").html("")}else{$("#isHidePoint").show();$("#canHavePoint").html(json.cartInfo.pointGift)}ec.order.point.count()},count:function(json){var petalDiscount=ec.order.petalAmount;var pointDiscount=ec.order.pointAmount;var $discountTotalPrice=$("#order-discountTotalPrice");var couponDiscount=parseFloat($("#order-couponDiscount").text(),10);$discountTotalPrice.text((parseFloat($discountTotalPrice.attr("data-oldVal"),10)+petalDiscount+pointDiscount+couponDiscount).toFixed(2));$("#oreder-point-num").text(pointDiscount.toFixed(2));$("#oreder-huaban-num").text(petalDiscount.toFixed(2));ec.order.newCount()}};ec.order.getSelectAddress2=function(){var selectAddrId="";$("#order-address-list ul li").each(function(i){var className=$(this).attr("class");if("current"==className||"hide current"==className){var id=$(this).find("input[name='myAddress']").attr("data-id");selectAddrId=ec.order.myAddress.districtList[id]}});return selectAddrId};function publicMethod(){var liList=$("#order-address-list").find("li");var adli=$("#order-address-list").css("display");if(liList!=null&&liList.length>0&&adli!="none"){for(var i=0;i<liList.length;i++){if($(liList[i]).hasClass("current")){var defaultId=$(liList[i]).attr("index");if(defaultId){ec.order.myAddress.defaultId=defaultId;$("#peopleID").html($("#consignee-name-"+defaultId).html());$("#telID").html($("#consignee-tel-"+defaultId).html());$("#addressID").html($("#address-detail-"+defaultId).html());$("#peopleTelAddressID").show();$("#no-delivery-address-tips").hide()}else{$("#peopleID").html("");$("#telID").html("");$("#addressID").html("");$("#no-choose-address").text("未选择收货地址不可下单");$("#link-choose-address").text("点击选择");$("#link-choose-address").unbind("click");$("#peopleTelAddressID").hide();$("#no-delivery-address-tips").show()}break}else{$("#peopleID").html("");$("#telID").html("");$("#addressID").html("");if(liList.length==1){$("#no-choose-address").text("无收货地址不可下单");$("#link-choose-address").text("点击填充");$("#link-choose-address").bind("click",function(){ec.order.myAddress.add()});$("#no-delivery-address-tips").show();$("#peopleTelAddressID").hide();break}else{$("#no-choose-address").text("未选择收货地址不可下单");$("#link-choose-address").text("点击选择");$("#link-choose-address").unbind("click");$("#peopleTelAddressID").hide();$("#no-delivery-address-tips").show()}}}}else{$("#peopleID").html("");$("#telID").html("");$("#addressID").html("");$("#peopleTelAddressID").show();$("#no-delivery-address-tips").hide()}}var eidtSelectAddressId="";ec.order.myAddress={list:{},districtList:{},length:function(){var list=ec.order.myAddress.list,key,len=0;for(key in list){len=len+1}return len},defaultId:null,defaultAddrId:null,curId:null,curType:null,load:function(addrList,addrFlag,K){var lst=addrList,lstLength,i,htmlFtl=[],thix=ec.order.myAddress;var d_Id,d_district;$("#randomFlag").valS(addrFlag);lstLength=lst.length;if(lstLength>3){$(".address-expand").show();$(".address-shrink").hide()}else{$(".address-expand").hide();$(".address-shrink").hide()}for(i=0;i<lstLength;i++){thix.list[lst[i].id]=lst[i];thix.districtList[lst[i].id]=lst[i].province+"|"+lst[i].city+"|"+lst[i].district;var addrInfo=$.extend({},lst[i]);for(var key in addrInfo){addrInfo[key]=ec.autoEncodeAttr(addrInfo[key])}if(i>2){htmlFtl.push('<li id="myAddress-'+addrInfo.id+'" index="'+addrInfo.id+'" class="hide">')}else{if(addrInfo.defaultFlag==1){htmlFtl.push('<li id="myAddress-'+addrInfo.id+'" index="'+addrInfo.id+'" class="current">')}else{htmlFtl.push('<li id="myAddress-'+addrInfo.id+'" index="'+addrInfo.id+'">')}}htmlFtl.push('<div class="address-supplement hide"><a href="javascript:;" onclick="ec.order.myAddress.edit('+addrInfo.id+')" class="address-add-btn">');if(addrInfo.needModify==true){htmlFtl.push("请您核实地址")}else{htmlFtl.push("请完善街道信息")}htmlFtl.push("</a></div>");if(addrInfo.defaultFlag==1){htmlFtl.push('<span id="defaultAddress-'+addrInfo.id+'" class="address-status">默认地址</span>')}else{htmlFtl.push('<span id="defaultAddress-'+addrInfo.id+'" class="address-status hide">默认地址</span>')}htmlFtl.push('<div class="address-main" onclick="ec.order.myAddress.select(this);">');htmlFtl.push('<p class="clearfix">');htmlFtl.push('<b id="consignee-name-'+addrInfo.id+'">'+addrInfo.consignee+"</b>");htmlFtl.push('<span id="consignee-tel-'+addrInfo.id+'">');if(addrInfo.mobile&&addrInfo.mobile.length>0){htmlFtl.push(addrInfo.mobile)}else{htmlFtl.push(addrInfo.phone)}htmlFtl.push("</span>");htmlFtl.push("</p>");htmlFtl.push('<div class="address-detail" id="address-detail-'+addrInfo.id+'">');var streetName="";if(addrInfo.streetName!=null&&addrInfo.streetName!=""){streetName=addrInfo.streetName}if(addrInfo.provinceName==null){addrInfo.provinceName="  "}if(addrInfo.cityName==null){addrInfo.cityName="  "}if(addrInfo.districtName==null){addrInfo.districtName="  "}addrInfo.districtName=ec.address.replaceChar(addrInfo.districtName);htmlFtl.push(addrInfo.provinceName+"&nbsp;"+addrInfo.cityName+"&nbsp;"+addrInfo.districtName+"&nbsp;"+streetName+"&nbsp;"+addrInfo.address);htmlFtl.push("</div>");htmlFtl.push("</div>");htmlFtl.push('<input type="hidden" id="needL4Addr" value="'+addrInfo.needL4Addr+'" />');htmlFtl.push('<input type="hidden" id="needModify" value="'+addrInfo.needModify+'" />');htmlFtl.push('<input type="hidden" name="streetName" value="'+streetName+'" />');htmlFtl.push('<input type="hidden" name="myAddress" id="input-myAddress'+addrInfo.id+'" data-province="'+addrInfo.province+'" data-city="'+addrInfo.city+'" data-district="'+addrInfo.district+'" data-id="'+addrInfo.id+'" value="'+addrInfo.id+'" />');htmlFtl.push('<div class="address-sub">');htmlFtl.push('<a class="address-edit" href="javascript:;" onclick="ec.order.myAddress.edit('+addrInfo.id+')">编辑</a>');htmlFtl.push('<a class="address-del"  href="javascript:;" onclick="ec.order.myAddress.del(this,'+addrInfo.id+')">删除</a>');if(addrInfo.defaultFlag==1){haveDefaultFlag=true;thix.defaultId=addrInfo.id;thix.defaultAddrId=addrInfo.id;d_Id=addrInfo.id;d_district=addrInfo.district;htmlFtl.push('<a id="setAddress-'+addrInfo.id+'" class="address-default hide" href="javascript:;" onclick="ec.order.myAddress.setDetault('+addrInfo.id+')">设为默认</a>')}else{thix.defaultId=null;htmlFtl.push('<a id="setAddress-'+addrInfo.id+'" class="address-default" href="javascript:;" onclick="ec.order.myAddress.setDetault('+addrInfo.id+')">设为默认</a>')}htmlFtl.push("</div>");htmlFtl.push("</li>")}if(lstLength<3){htmlFtl.push('<li id="address-empty">');$("#upAddAddressButton").hide()}else{htmlFtl.push('<li id="address-empty" class="hide">');$("#upAddAddressButton").show()}htmlFtl.push('<div class="address-empty">');htmlFtl.push('<a href="javascript:;" class="address-add-btn" onclick="ec.order.myAddress.add()">');htmlFtl.push("新增收货地址");htmlFtl.push("</a>");htmlFtl.push("</div>");htmlFtl.push("</li>");$("#order-address-list > ul").html(htmlFtl.join("")).show();var flag=false;var liList=$("#order-address-list input[name='myAddress']");for(var p=0;p<liList.length;p++){var li=liList[p];if(li.checked){d_Id=$(li).attr("data-id");d_district=$(li).attr("data-district");flag=true}}if(eidtSelectAddressId!=""){$("#order-address-list ul").prepend($("#myAddress-"+eidtSelectAddressId));$("#order-address-list li:gt(2)").hide();$("#order-address-list li:lt(3)").show();$("#myAddress-"+eidtSelectAddressId).addClass("current").siblings().removeClass("current")}thix.init();if($("#order-address-list li.current input[id='needL4Addr']").val()=="true"){$("#order-address-list li.current").find(".address-supplement").show();$("#order-address-list li.current").find(".address-main").addClass("disabled");$("#order-address-list li.current").find(".address-sub").addClass("address-shield")}if($("#order-address-list li.current input[id='needModify']").val()=="true"){$("#order-address-list li.current").find(".address-supplement").show();$("#order-address-list li.current").find(".address-main").addClass("disabled");$("#order-address-list li.current").find(".address-sub").addClass("address-shield")}var id=$("#order-address-list li.current input[name='myAddress']").attr("data-id");var district=$("#order-address-list li.current input[name='myAddress']").attr("data-district");if(ec.order.shippingDate==""){if(ec.order.deadlineTime!=""&&ec.order.deadlineTime!=null&&ec.order.deadlineTime!="undefined"){ec.order.showSupportDisplayDilieryTimeTemp(ec.order.deadlineTime,ec.order.earlyArrivalTime,ec.order.lateArrivalTime,ec.order.beforeAndAfterFlag,false);ec.order.estimatedArrivalTime=""}else{ec.order.selectAddress(id,district)}}if($(".order-main").find("ul").eq(0).find("a").eq(0).text().trim().substring(0,2)=="套餐"){ec.order.hiddenTips();return}},init:function(){var curData,curId,thix=ec.order.myAddress;if(thix.curType=="add"){}else if(thix.curType=="update"){}else{$("#order-address-list li:gt(2)").hide();$("#order-address-list li:lt(3)").show()}publicMethod()},isChange:function(oldData,newData){var oldVal,key;for(key in newData){oldVal=oldData[key]==null||!oldData[key]?"":$.trim(oldData[key]);if($.trim(newData[key])!=oldVal){return true;break}}return false},isChange:function(oldData,newData){var oldVal,key;for(key in newData){oldVal=oldData[key]==null||!oldData[key]?"":$.trim(oldData[key]);if($.trim(newData[key])!=oldVal){return true;break}}return false},indexOf:function(list,curData){var len,n;if(curData){for(var key in list){len=0;n=0;for(var kk in curData){if($.trim(curData[kk])===$.trim(list[key][kk])){n+=1}len+=1}if(n==len){return key}}}return false},add:function(){$("#myAddress-edit-new-box").remove();$("#order-invoice-edit").remove();var thix=ec.order.myAddress;ec.address.defaultTabValue();ec.address.cleanValue();ec.address.processType="0";thix.box=new ec.box('<div id="order-address-add-area"></div>',{boxid:"myAddress-add-new-box",boxclass:"ol_box_4",width:800,title:"添加地址",showButton:false,onopen:function(box){var $addForm=$("#order-address-add-area"),randomFlag=$("#randomFlag").val();$addForm.html(ec.order.getAddressBox());$addForm.find("form").attr("data-type","add");$addForm.find("input[name='randomFlag']").valS(randomFlag);$("#myAddress-msg").removeClass("icon-error");ec.order.myAddress.bind($addForm);ec.address.bindSeelctEvent();box.setPosition()}}).open()},edit:function(id){$("#myAddress-add-new-box").remove();$("#order-invoice-edit").remove();ec.address.defaultTabValue();ec.address.cleanValue();var thix=ec.order.myAddress,curData=thix.list[id];thix.box=new ec.box('<div id="order-address-edit-area"></div>',{boxid:"myAddress-edit-new-box",boxclass:"ol_box_4",width:800,title:"修改地址",showButton:false,onopen:function(box){var $editForm=$("#order-address-edit-area"),randomFlag=$("#randomFlag").val();$editForm.html(ec.order.getAddressBox());$editForm.find("input[name='id']").valS(curData.id);$editForm.find("input[name='consignee']").valS(curData.consignee);$editForm.find("textarea[name='address']").valS(curData.address);$editForm.find("input[name='zipCode']").valS(curData.zipCode);$editForm.find("input[name='mobile']").valS(curData.mobile);$editForm.find("input[name='phone']").valS(curData.phone);$("#myAddress-msg").removeClass("icon-error");var distrackId="";if(curData.street!=""&&curData.street!=null){distrackId=curData.street}else{distrackId=curData.district}ec.order.myAddress.bind($editForm);ec.address.bindSeelctEvent();box.setPosition();ec.address.setValue(curData);ec.address.processType="0";ec.address.queryData(ec.address.parseUrl(tree_url,distrackId),true,1,ec.address.getCitydistrict)}}).open()},addData:function(form){return{id:$.trim(form.find("input[name='id']").val()),consignee:$.trim(form.find("input[name=consignee]").val()),provinceName:form.find("input[name='province']").html(),cityName:form.find("input[name='city']").html(),districtName:form.find("input[name='district']").html(),district:form.find("input[name='district']").val(),street:form.find("input[name='street']").val(),address:$.trim(form.find("textarea[name='address']").val()),zipCode:$.trim(form.find("input[name='zipCode']").val()),mobile:$.trim(form.find("input[name='mobile']").val()),phone:$.trim(form.find("input[name='phone']").val())}},save:function(obj){var form=$(obj).closest("form"),type="update",thix=ec.order.myAddress,curId=form.find("input[name='id']").val(),newData=thix.addData(form);ec.addr.syncCache(form);newData=thix.addData(form);province=form.find("input[name='province']").val(),city=form.find("input[name='city']").val(),district=form.find("input[name='district']").val(),street=form.find("input[name='street']").val();if(curId&&thix.list[curId]){if(!thix.isChange(thix.list[curId],newData)){ec.order.myAddress.box.close();return}}if(thix.indexOf(thix.list,newData)>0){form.find(".box-form-tips span").addClass("icon-error").html("已存在此地址");return}if(form.attr("data-type")=="add"){type="add";thix.curId=null;thix.curType="add"}else{thix.curId=form.find("input[name=id]").val();thix.curType="update"}ec.addr.save(form,{type:type,successFunction:function(shoppingConfig,bForm){eidtSelectAddressId=shoppingConfig.id;ec.order.myAddress.box.close();ec.addr.list(ec.order.myAddress.load);if(ec.order.shopCode!=undefined){if(ec.order.isProxySale=="true"){ec.order.queryPayDelivery(eidtSelectAddressId,district)}else{ec.order.computeDelieryFee()}}else{ec.order.queryPayDelivery(eidtSelectAddressId,district)}}});return false},cancel:function(){ec.order.myAddress.box.close()},setDetault:function(id){ec.addr.setDefault(id,{successFunction:function(){$("#myAddress-"+id).find(".address-status").removeClass("hide");$("#myAddress-"+id).find(".address-default").hide();$("#order-address-list").find("li").each(function(){var curId=$(this).attr("id");var myAddrId="myAddress-"+id;if(curId!=myAddrId){curId=curId.substring(10);$("#myAddress-"+curId).find(".address-status").addClass("hide");$("#myAddress-"+curId).find(".address-default").show()}})}})},del:function(dom,id){if(!ec.ui.confirm(dom,"您确认要删除该地址吗？")){return}ec.addr.del(id,{successFunction:function(id){var addressList=ec.order.myAddress.list;if(addressList[id]!=null){delete addressList[id]}ec.order.myAddress.districtList[id]=null;ec.order.myAddress.curType="";ec.order.myAddress.defaultId=null;var curIndex=$("#myAddress-"+id).index();if(curIndex<3){$("#order-address-list li:eq(3)").show()}$("#myAddress-"+id).remove();if($("#order-address-list li").length<4){$("#upAddAddressButton").hide();$("#address-empty").show()}else{$("#upAddAddressButton").show();$("#address-empty").hide()}if($("#order-address-list li").length<5){$("#address-more .address-expand").hide();$("#address-more .address-shrink").hide()}var id="";var district="";if($("#order-address-list li.current").length==0){if($("span[id^='defaultAddress-']:not(.hide)").length==1){$("span[id^='defaultAddress-']:not(.hide)").parent().addClass("current");id=$("#order-address-list li.current input[name='myAddress']").attr("data-id");district=$("#order-address-list li.current input[name='myAddress']").attr("data-district");ec.order.selectAddress(id,district)}}if(ec.order.shopCode!=undefined){if(ec.order.isProxySale=="true"){if(id!=""&&id!=null&&id!="undefined"){ec.order.queryPayDelivery(id,district)}}else{ec.order.computeDelieryFee()}}else{if(id!=""&&id!=null&&id!="undefined"){ec.order.queryPayDelivery(id,district)}}publicMethod()}})},bind:function(form){var _vb=ec.form.validator.bind,address=form.find("textarea[name=address]"),phone=form.find("input[name=phone]"),mobile=form.find("input[name=mobile]"),checkPhone=function(obj,options){var obj=obj.attr("name")==="mobile"?mobile:phone;var showSpan=$(options.msg_ct);if($.trim(mobile.val()).length==0){mobile.addClass("error");$(showSpan).addClass("icon-error");$(showSpan).text("手机号码不能为空")}else{if($.trim(obj.val()).length>0&&obj.hasClass("error")){return}else{if(mobile.hasClass("error")){$(showSpan).text("请填写正确的11位手机号码，例如：13XXXXXXXXX")}if(phone.hasClass("error")){$(showSpan).text("请填写正确的备选号码，固话格式为区号-主机-分机号")}if(!mobile.hasClass("error")&&!phone.hasClass("error")){$(showSpan).removeClass("icon-error");$(showSpan).text("")}}}};_vb(form.find("input[name=consignee]"),{type:["require","length","regex"],validOnChange:true,regex:/^[\uFF21-\uFF3A\uFF41-\uFF5A\u4E00-\u9FA5\s\u3000A-Za-z]+$/,min:2,max:20,msg_ct:form.find("#consignee-msg"),msg:{length:"收货人长度为2-20个字符，一个汉字为两个字符",regex:"收货人只能填写中文和英文字符",require:"请填写收货人"}});_vb(form.find("input[name=district]"),{type:["addressConfirmCheck"],validOnChange:true,msg_ct:$("#myAddress-msg"),msg:{addressConfirmCheck:"请填写完整的地区信息"}});_vb(address,{type:["require","length","forbidChar2"],validOnChange:true,max:100,msg_ct:form.find("#address-msg"),msg:{forbidChar2:"收货人详细地址中含有非法字符",length:"详细地址最长为100个字符，一个汉字为两个字符",require:"请填写详细地址"}});_vb(phone,{type:["mobleOrPhone"],validOnChange:true,msg_ct:form.find("#phone-msg"),msg:{default:"请填写正确的备选号码，固话格式为区号-主机-分机号"},successFunction:checkPhone});_vb(mobile,{type:["mobile"],validOnChange:true,msg_ct:form.find("#phone-msg"),msg:{default:"请填写正确的11位手机号码，例如：13XXXXXXXXX"},successFunction:checkPhone});ec.form.input.label(address,"如选择不到您的地区，请在此处详细描述").label(phone,"固话或其他手机号码").label(mobile,"请输入11位手机号码");form.find("input").change(function(){form.find(".box-form-tips span").html("").attr("class","")});form.find("textarea").change(function(){form.find(".box-form-tips span").html("").attr("class","")})},select:function(thix){$(thix).parent().addClass("current").siblings().removeClass("current");var id=$(thix).siblings("input[name='myAddress']").attr("data-id");var district=$(thix).siblings("input[name='myAddress']").attr("data-district");if(ec.order.shopCode!=undefined){if(ec.order.isProxySale=="true"){ec.order.queryPayDelivery(id,district)}else{ec.order.computeDelieryFee()}}else{ec.order.queryPayDelivery(id,district)}ec.order.selectAddress(id,district);var needL4Addr=$(thix).siblings("#needL4Addr").val();var needModify=$(thix).siblings("#needModify").val();if(needL4Addr=="true"){$(thix).siblings(".address-supplement").show();$(thix).addClass("disabled");$(thix).siblings(".address-sub").addClass("address-shield")}if(needModify=="true"){$(thix).siblings(".address-supplement").show();$(thix).addClass("disabled");$(thix).siblings(".address-sub").addClass("address-shield")}$(thix).parent().siblings().find(".address-supplement").hide();$(thix).parent().siblings().find(".address-main").removeClass("disabled");$(thix).parent().siblings().find(".address-sub").removeClass("address-shield");publicMethod()}};ec.order.queryPayDelivery=function(id,district){var _couponCode=$("#input-couponCode");var weight;var price;ec.order.myAddress.defaultId=id;if(_couponCode.val()){weight=ec.order.weight+(parseFloat(_couponCode.attr("data-weight"))||0);price=_couponCode.attr("data-totalprice")||0}else{weight=ec.order.weight;price=ec.order.price}$("#order-district").valS(district);ec.order.loadDeliery({id:id,district:district,weight:weight,price:price})};ec.order.loadDeliery=function(arg){var _address=$("#order-address-list li.current input[name=myAddress]"),id=arg.id||_address.attr("data-id"),district=arg.district||$("#order-district").val(),weight=arg.weight||ec.order.weight,isDeliveryFree=arg.isDeliveryFree||ec.order.isDeliveryFree,wareHouseId=$("#wareHouseId").val();realPrice=ec.order.realTotalPrice;var $form=$("#order-confirm-form");var regionId=ec.order.getSelectAddress2();var orderReq=$("input[name=orderReq]",$form).val();var usePetalEnable=$("#usePetalFlag").val();var usePointEnable=$("#usePointFlag").val();var UIDesignID=$("input[name=UIDesignID]",$form).val();var sbs=$("input[name=sbs]",$form).val();titleTypes=[];$(".order-titleType").each(function(){var thix=$(this);titleTypes.push(thix.attr("id").replace("order-titleType","")+":"+thix.attr("value"))});var url="";var orderType=$("#orderType").val();url="/order/queryPayDelieryTemp.json";var dataInfo={sbs:sbs,orderType:orderType,orderReq:orderReq,id:id,districtId:district};ec.order.queryPayDeliery(url,dataInfo)};ec.order.queryPayDeliery=function(url,dataInfo){(new ec.ajax).post({url:url,data:dataInfo,timeout:1e8,timeoutFunction:function(){ec.order.ecboxOpen(timeOutInfo)},beforeSendFunction:function(){ec.ui.loading.show({modal:false})},afterSendFunction:ec.ui.loading.hide,successFunction:function(json){if(!json.success){ec.showError(json);return}var maps=json.maps;var countTemp=0;var counter=0;var regulationCount=0;if(maps!=null&&maps!=""){var countFlagInfo=0;var mainSkuCodeInfo="";for(var key in maps){counter++;if(maps[key]!=null&&maps[key]!=""){regulationCount=maps[key].substring(maps[key].indexOf("&")+1);maps[key]=maps[key].substring(0,maps[key].indexOf("&"))}var e=$("."+key).length;if(maps[key]=="12"){$("."+key).parent().find("div").remove();$("."+key).after("<div class='report-errors'>此商品暂不支持该地区的配送</div>");countFlagInfo++;$("."+key).parent().parent().addClass("disabled");$("."+key).parent().parent().parent().addClass("disabled");if(key.indexOf("-")>-1){if($("#"+key).val()=="sunProduct"){$("#"+key).parent().parent().parent().parent().find("ul").addClass("disabled");$("#"+key).parent().parent().parent().parent().find("div").eq(0).addClass("disabled")}}else{if(e>1){$("."+key).parent().parent().parent().parent().find("ul").addClass("disabled")}else{$("#"+key).parent().parent().parent().parent().find("ul").addClass("disabled")}}}if(maps[key]=="6"){if(e>1){$("."+key).parent().find("div").remove();$("."+key).after("<div class='report-errors'>此商品暂时缺货</div>");$("."+key).parent().parent().addClass("disabled");$("."+key).parent().parent().parent().addClass("disabled")}else{$("#"+key).parent().find("div").remove();$("#"+key).after("<div class='report-errors'>此商品暂时缺货</div>");$("#"+key).parent().parent().addClass("disabled");$("#"+key).parent().parent().parent().addClass("disabled")}}if(maps[key]=="1"||maps[key]=="2"||maps[key]=="3"||maps[key]=="4"||maps[key]=="5"){if(e>1){$("."+key).parent().find("div").remove();$("."+key).after("<div class='report-errors'>此商品不可购买</div>");$("."+key).parent().parent().addClass("disabled");$("."+key).parent().parent().parent().addClass("disabled")}else{$("#"+key).parent().find("div").remove();$("#"+key).after("<div class='report-errors'>此商品不可购买</div>");$("#"+key).parent().parent().addClass("disabled");$("#"+key).parent().parent().parent().addClass("disabled")}}if(maps[key]=="7"||maps[key]=="8"){if(e>1){$("."+key).parent().find("div").remove();$("."+key).after("<div class='report-errors'>限购"+regulationCount+"件</div>");$("."+key).parent().parent().addClass("disabled");$(".#"+key).parent().parent().parent().addClass("disabled")}else{$("#"+key).parent().find("div").remove();$("#"+key).after("<div class='report-errors'>限购"+regulationCount+"件</div>");$("#"+key).parent().parent().addClass("disabled");$("#"+key).parent().parent().parent().addClass("disabled")}if(key.indexOf("-")>-1){if($("#"+key).val()=="sunProduct"){$("#"+key).parent().parent().parent().parent().find("ul").addClass("disabled");var temt=key.substring(0,key.indexOf("-"));$("#"+temt).parent().parent().parent().addClass("disabled")}}else{if(e>1){$("."+key).parent().parent().parent().parent().find("ul").addClass("disabled")}else{$("#"+key).parent().parent().parent().parent().find("ul").addClass("disabled")}}}if(maps[key]=="0"){$("."+key).parent().find("div").remove();if(key.indexOf("-")>-1){}else{$("."+key).parent().parent().parent().removeClass("disabled");$("."+key).parent().parent().removeClass("disabled");mainSkuCodeInfo=key}if(key.indexOf("-")>-1){var temt=key.substring(0,key.indexOf("-"));if($("#"+key).parent().parent().parent().parent().find("div").eq(0).hasClass("disabled")){}else{$("."+key).parent().parent().parent().removeClass("disabled");$("."+key).parent().parent().removeClass("disabled")}if(maps[temt]=="12"||maps[temt]=="6"||maps[temt]=="7"||maps[temt]=="8"||maps[temt]=="1"||maps[temt]=="2"||maps[temt]=="3"||maps[temt]=="4"||maps[temt]=="5"){$("#"+key).parent().parent().addClass("disabled");$("#"+key).parent().parent().parent().addClass("disabled");$("."+key).parent().parent().addClass("disabled");$("."+key).parent().parent().parent().addClass("disabled")}}else{if(e>1){$("."+key).parent().parent().parent().parent().find("ul").removeClass("disabled")}else{$("#"+key).parent().parent().parent().parent().find("ul").removeClass("disabled")}}countTemp++}}if(json.packageFlag=="yes"&&countFlagInfo>0){$("."+mainSkuCodeInfo).parent().parent().parent().addClass("disabled");$("."+mainSkuCodeInfo).parent().parent().addClass("disabled");if(e>1){$("."+mainSkuCodeInfo).parent().parent().parent().parent().find("ul").addClass("disabled")}else{$("#"+mainSkuCodeInfo).parent().parent().parent().parent().find("ul").addClass("disabled")}}if(ec.order.shopCode!=undefined){ec.order.computeDelieryFee()}else{}}}})};var cache_coupon_by_inputCode=null;ec.order.openPopWindowWithContent=function(html,boxId,width,heigth,title){var box=new ec.box(html,{boxclass:"ol_box_4 ol_box_title",boxid:boxId,title:title,width:width,modal:true,showButton:false,autoHeight:false,height:heigth,onok:function(box){box.close()}}).open()};ec.order.openPopWindow=function(domId,boxId,width,heigth,title){return ec.order.openPopWindowWithContent($("#"+domId).html(),boxId,width,heigth,title)};ec.order.couponCacheShops={};ec.order.couponEnable={};ec.order.openPopCoupon=function(boxId,width,heigth,title,shopCode){ec.order.openPopWindowWithContent($("#order-coupon-tpl").val(),boxId,width,heigth,title);shopCode=shopCode||$($("#order-roll-coupon .order-roll-list ul li")[0]).attr("shopcode-info");var couponCode=ec.order.shopCouponCodes(shopCode);if(couponCode.length){if(cache_coupon_by_inputCode){$("#li_coupon").addClass("current");$("li[index^='effCouponInfo_']").removeClass("current")}}else{$("#code_use_coupon_btn").unbind("click");$("#code_use_coupon_btn").addClass("disabled");$("#use_coupon_btn").unbind("click");$("#use_coupon_btn").addClass("disabled");$("li[index^='effCouponInfo_']").removeClass("current")}if(cache_coupon_by_inputCode){$("#li_coupon").html(cache_coupon_by_inputCode.coupon);$("#li_coupon").attr("code",cache_coupon_by_inputCode.code);$("#li_coupon").attr("data",cache_coupon_by_inputCode.data);$("#li_coupon").removeClass("order-roll-discount");$("#li_coupon").removeClass("order-roll-type");$("#li_coupon").addClass(cache_coupon_by_inputCode.couponStyle);$("#couponCode2").valS(cache_coupon_by_inputCode.code);ec.order.couponTabChange("coupon_code_tab");$("#code_use_coupon_btn").removeClass("disabled");$("#coupon-code-div").show()}ec.order.slideUpIntro();if(!ec.order.couponCacheShops[shopCode]){$("#order-roll-coupon .order-roll-detail").each(function(){if($(this).attr("id")){ec.order.couponEnable[$(this).attr("id")]=!$(this).hasClass("disabled")}});ec.order.couponCacheShops[shopCode]=true;return false}$("#order-roll-coupon .order-roll-detail").each(function(){if($(this).attr("id")){$(this).removeClass("current").addClass("disabled")}});for(var i=0;i<couponCode.length;i++){$("#"+couponCode[i]).addClass("current").removeClass("disabled")}for(var k in ec.order.couponEnable){if(ec.order.couponEnable.hasOwnProperty(k)){if(ec.order.couponEnable[k]){$("#"+k).removeClass("disabled")}}}ec.order.tmpCoupons.refresh(shopCode)};ec.order.shopCouponCodes=function(shopCode){shopCode=shopCode||"";var couponCodes=null;try{couponCodes=JSON.parse($("#order-couponCode").val())}catch(e){}if(couponCodes&&couponCodes.length>0){for(var i=0;i<couponCodes.length;i++){if(shopCode===couponCodes[i].carrierCode){return couponCodes[i].couponCodes||[]}}}return[]};ec.order.setCouponCodes=function(shopCode,codeslists){ec.order.tmpCoupons.cls(shopCode);codeslists=ec.order.couponReplace(codeslists);$("#usedCouponCodesID_"+shopCode).valS(codeslists);var couponCodes=[];try{couponCodes=JSON.parse($("#order-couponCode").val())}catch(e){}var hasShop=false;if(couponCodes&&couponCodes.length>0){for(var i=0;i<couponCodes.length;i++){if(shopCode===couponCodes[i].carrierCode){hasShop=true;if(codeslists){couponCodes[i].couponCodes=codeslists.split(",")}else{couponCodes.splice(i,1)}}}}if(!hasShop&&codeslists){couponCodes.push({carrierCode:shopCode,couponCodes:codeslists.split(",")})}if(couponCodes.length>0){$("#order-couponCode").val(JSON.stringify(couponCodes))}else{$("#order-couponCode").val("")}};ec.order.invalidProduct=function(productList){ec.order.invalidProduct.box=new ec.box('<div id="order-invalid-product"></div>',{boxid:"order-invalid-product-box",boxclass:"ol_box_4",width:700,height:500,title:"",showButton:false,onopen:function(box){var $addForm=$("#order-invalid-product");$addForm.html(ec.order.invalidProductBox(productList));box.setPosition()},onclose:function(){ec.order.goBackButton()}}).open()};ec.order.noAddressBox=function(){var html=[];html.push('<div class="box-content">');html.push('<div class="box-errors-1"><span>要送到哪里呢？请先填写收货地址吧~</span></div>');html.push('<div class="box-button">');html.push(' <a href="javascript:;" class="box-ok" onclick="ec.order.scrollTopAddress();"><span>确定</span></a>');html.push("</div>");html.push("</div>");ec.order.noAddressBox.box=new ec.box(html.join(" "),{boxid:"no-write-address-box",boxclass:"ol_box_4 small",title:"",showButton:false,onopen:function(box){box.setPosition()},onclose:function(){$("html,body").animate({scrollTop:$("#order-address-list ul").offset().top-100},100)}}).open()};ec.order.scrollTopAddress=function(){$("html,body").animate({scrollTop:$("#order-address-list ul").offset().top-100},100)};ec.order.noProduct=function(){var html=[];html.push('<div class="box-content">');html.push('<div class="box-errors-1">');if($("#orderType").val()==30){html.push("<span>部分商品暂不可购买</span>")}else{html.push("<span>全部商品均不可购买</span>")}html.push("</div>");html.push('<div class="box-button">');html.push(' <a href="javascript:;" class="box-cancel" onclick="ec.order.goBack();"><span>返回上一页</span></a>');html.push("</div>");html.push("</div>");new ec.box(html.join(" "),{boxid:"no_product_tips",boxclass:"ol_box_4 small",title:"",showButton:false,onopen:function(box){box.setPosition();ec.order.goBackButton()}}).open()};ec.order.invalidSubmitProduct=function(){$("#checkoutSubmit").addClass("disabled");var orderType=$("#orderType").val();var UIDesignID=$("input[name='UIDesignID']").val();var sbs=$("input[name='sbs']").val();var css=$("input[name='css']").val();var qtys=$("input[name='qtys']").val();var ess=$("input[name='ess']").val();var ass=$("input[name='ass']").val();var addressId=$("input[name='consigneeAddressId']").val();var couponCode=$("input[name='couponCode']").val();var orderReq=$("input[name='orderReq']").val();var iMeiCode=$("input[name='imeiCode']").val();if(orderType=="25"){data={UIDesignID:UIDesignID,sbs:sbs,css:css,qtys:qtys,ess:ess,ass:ass,orderType:orderType,addressId:addressId,couponCode:couponCode}}else{data={orderReq:orderReq,orderType:orderType,addressId:addressId,couponCode:couponCode,imeiCode:iMeiCode}}$("#checkoutSubmit").addClass("disabled");$.ajax({url:"/order/validateOrder.json",timeout:1e4,type:"POST",data:data,success:function(json){var json=ec.lang.json.parse(json);if(!json.success){if(json.errorCode=="noProduct"){ec.order.noProduct();$("#checkoutSubmit").removeClass("disabled");return}else if(json.errorCode=="addressError"){if(json.msg!=""&&json.msg!=undefined&&json.msg!=null){ec.order.ecboxOpen(json.msg)}else{ec.order.ecboxOpen("您的收货地址有误,请修改收货地址再试！")}$("#checkoutSubmit").removeClass("disabled");return}else if(json.errorCode=="errorMsg"){ec.order.ecboxOpen(json.msg);$("#checkoutSubmit").removeClass("disabled");return}else{var input="";input+='<input name="errorCode" type="text" value=\''+json.errorCode+"'>";input+='<input name="errorMsg" type="text" value="'+json.msg+'">';var $form=$("#validateForward");$form.append(input);$("body").append($form);$form.submit()}}if(ec.lang.json.parse(json.invalidProductList.transHtmlAttribute()).length>0){var r=ec.lang.json.parse(json.invalidProductList.transHtmlAttribute());ec.encryptJSON(r);ec.order.invalidProduct(r)}else{ec.order.splitOrder()}},error:function(){ec.order.ecboxOpen("操作超时，请重试！");$("#checkoutSubmit").removeClass("disabled")}})};ec.order.removeProduct=function(){var orderReq=ec.lang.json.parse($("input[name='orderReq']").val());if(orderReq&&orderReq.length>0){for(var j=0;j<orderReq.length;j++){if(!orderReq[j]){orderReq.splice(j,1)}if(orderReq[j]&&orderReq[j].gifts){for(var k=0;k<orderReq[j].gifts.length;k++){if(!orderReq[j].gifts[k]){orderReq[j].gifts.splice(k,1)}}if(orderReq[j].gifts.length==0){delete orderReq[j].gifts}}}}$("#order-no-list ul input[name^='main']").each(function(){if(orderReq!=null&&orderReq.length>0){for(var i=0;i<orderReq.length;i++){if(orderReq[i].itemId==this.value&&orderReq[i].itemType==$(this).attr("itemtype")){orderReq.splice(i,1)}}}});$("#order-no-list ul input[name^='sub']").each(function(){if(this.value==$("input[name='ess']").val()){$("input[name='ess']").val("")}else if(this.value==$("input[name='ass']").val()){$("input[name='ass']").val("")}if(orderReq!=null&&orderReq.length>0){for(var i=0;i<orderReq.length;i++){if(orderReq[i].subOrderItemReqArgs!=null&&orderReq[i].subOrderItemReqArgs.length>0){for(var j=0;j<orderReq[i].subOrderItemReqArgs.length;j++){if(orderReq[i].subOrderItemReqArgs[j].itemId==this.value&&orderReq[i].subOrderItemReqArgs[j].itemType==$(this).attr("itemtype")&&orderReq[i].itemId==$(this).attr("data-mainCode")){orderReq[i].subOrderItemReqArgs.splice(j,1)}}}}}});$("#order-no-list ul input[name^='sbomCode']").each(function(){if(orderReq!=null&&orderReq.length>0){for(var j=0;j<orderReq.length;j++){if(orderReq[j].gifts!=null){if((orderReq[j].itemType=="S0"||orderReq[j].itemType=="P"||orderReq[j].itemType=="DE"||orderReq[j].itemType=="DP")&&orderReq[j].gifts.length>0){for(var k=0;k<orderReq[j].gifts.length;k++){if(orderReq[j].gifts[k].sbomCode==this.value&&orderReq[j].itemId==$(this).attr("data-mainCode")&&orderReq[j].itemType==$(this).attr("itemtype")){orderReq[j].gifts.splice(k,1)}}}}}}});for(var j=0;j<orderReq.length;j++){if(orderReq[j].gifts!=null&&orderReq[j].gifts.length==0){delete orderReq[j].gifts}if(orderReq[j].subOrderItemReqArgs!=null&&orderReq[j].subOrderItemReqArgs.length==0){delete orderReq[j].subOrderItemReqArgs}}$("input[name='orderReq']").val(ec.lang.json.stringify(orderReq));ec.order.invalidProduct.box.close();var state=$("input[name='state']").val();var orderReq=$("input[name='orderReq']").val();var orderType=$("input[name='orderType']").val();var interestOrder=$("input[name='interestOrder']").val();if(orderType==16){var input="";input+='<input name="orderReqJson" type="hidden" value=\''+orderReq+"' />";input+='<input name="state" type="hidden" value="'+state+'" />';input+='<input name="routingTag" type="hidden" value="'+orderType+'" />';$("#tokenConfirm").attr("action","/order/priorityConfirm");$("#tokenConfirm").append(input);$("#tokenConfirm").submit()}else if(orderType==18){var input="";input+='<input name="orderReqJson" type="hidden" value=\''+orderReq+"' />";input+='<input name="state" type="hidden" value="'+state+'" />';input+='<input name="routingTag" type="hidden" value="'+orderType+'" />';$("#tokenConfirm").attr("action","/order/confirmDeposit");$("#tokenConfirm").append(input);$("#tokenConfirm").submit()}else if(orderType==10){var input="";input+='<input name="orderReqJson" type="hidden" value=\''+orderReq+"' />";input+='<input name="state" type="hidden" value="'+state+'" />';input+='<input name="routingTag" type="hidden" value="'+orderType+'" />';$("#tokenConfirm").attr("action","/order/confirmDepositNew");$("#tokenConfirm").append(input);$("#tokenConfirm").submit()}else if(orderType==26){var input="";input+='<input name="orderReqJson" type="text" value=\''+orderReq+"'>";input+='<input name="routingTag" type="text" value="26">';input+='<input name="productId" type="text" value="'+ec.order.productId+'">';input+='<input name="skuId" type="text" value="'+ec.order.skuId+'">';input+='<input name="state" type="text" value="0">';$("#tokenConfirm").attr("action","/order/nowConfirmcart");$("#tokenConfirm").append(input);$("#tokenConfirm").submit()}else if(orderType==14){var input="";var iMeiCode=$("input[name='imeiCode']").val();input+='<input name="orderReqJson" type="text" value=\''+orderReq+"'>";input+='<input name="productId" type="text" value="'+ec.order.productId+'">';input+='<input name="skuId" type="text" value="'+ec.order.skuId+'">';input+='<input name="imeiCode" type="text" value="'+iMeiCode+'">';$("#tokenConfirm").attr("action","/order/tcsConfirm");$("#tokenConfirm").append(input);$("#tokenConfirm").submit()}else if(orderType==35){var input="";var iMeiCode=$("input[name='imeiCode']").val();input+='<input name="orderReqJson" type="text" value=\''+orderReq+"'>";input+='<input name="productId" type="text" value="'+ec.order.productId+'">';input+='<input name="skuId" type="text" value="'+ec.order.skuId+'">';input+='<input name="imeiCode" type="text" value="'+iMeiCode+'">';$("#tokenConfirm").attr("action","/order/batteryConfirm");$("#tokenConfirm").append(input);$("#tokenConfirm").submit()}else{var input="";input+='<input name="orderReqJson" type="hidden" value=\''+orderReq+"' />";input+='<input name="state" type="hidden" value="'+state+'" />';input+='<input name="routingTag" type="hidden" value="'+orderType+'" />';if(interestOrder){input+='<input name="interest" type="hidden" value="'+interestOrder+'" />'}$("#tokenConfirm").attr("action","/order/confirmcart");$("#tokenConfirm").append(input);$("#tokenConfirm").submit()}};ec.order.goBack=function(){if($("#orderType").val()==14){ec.redirectTo(domainMain+"/order/tcsProductIndex")}else if($("#orderType").val()==35){ec.redirectTo(domainMain+"/order/batteryRenew")}else{var state=$("input[name='state']").val();if(state==0){if($("#orderType").val()==26){ec.redirectTo("/product/"+ec.order.productId+".html#"+ec.order.skuId)}else{ec.redirectTo($("a.p-name").attr("ahref"))}}else{ec.redirectTo(domainMain+"/cart2")}}};ec.order.couponTabChange=function(couponTab){if(couponTab=="coupon_tab"){$("#coupon_tab").addClass("current");$("#coupon_code_tab").removeClass("current");$("#coupon_tab_2").removeClass("current");$("#order-roll-coupon>:first").removeClass("hide");$("#order-roll-coupon>:gt(0)").removeClass("hide");$("#order-roll-coupon-2>:first").addClass("hide");$("#order-roll-coupon-2>:eq(1)").addClass("hide");$("#order-roll-code>:first").addClass("hide");$("#order-roll-code>:eq(1)").addClass("hide");if($("li[name^='effCouponInfo_']").hasClass("current")){$("#use_coupon_btn").removeClass("disabled")}else{$("#use_coupon_btn").addClass("disabled");$("li[index^='effCouponInfo_']").removeClass("current")}var couponCode=null;if($("#coupon_tab").attr("class")=="current"){couponCode=$("#order-roll-coupon li.order-roll-detail.current").attr("id")}}else if(couponTab=="coupon_code_tab"){$("#coupon_tab").removeClass("current");$("#coupon_tab_2").removeClass("current");$("#coupon_code_tab").addClass("current");$("#order-roll-coupon>:first").addClass("hide");$("#order-roll-coupon>:gt(0)").addClass("hide");$("#order-roll-coupon-2>:first").addClass("hide");$("#order-roll-coupon-2>:eq(1)").addClass("hide");$("#order-roll-code>:first").removeClass("hide");$("#order-roll-code>:eq(1)").removeClass("hide")}else{$("#coupon_tab").removeClass("current");$("#coupon_code_tab").removeClass("current");$("#coupon_tab_2").addClass("current");$("#order-roll-coupon>:first").addClass("hide");$("#order-roll-coupon>:gt(0)").addClass("hide");$("#order-roll-coupon-2>:first").removeClass("hide");$("#order-roll-coupon-2>:eq(1)").removeClass("hide");$("#order-roll-code>:first").addClass("hide");$("#order-roll-code>:eq(1)").addClass("hide");ec.order.slideUpIntro()}};ec.order.couponReplace=function(codeslists){codeslists=codeslists.replaceAll(",,",",");if(codeslists.substring(0,1)==","){codeslists=codeslists.substring(1)}else if(codeslists.substring(codeslists.length-1)==","){codeslists=codeslists.substring(0,codeslists.length-1)}return codeslists};ec.order.couponSelected=function(couponCode){if($("#"+couponCode).hasClass("disabled")){$("#toast").show();setTimeout(function(){$("#toast").addClass("toast-hide")},1500);setTimeout(function(){$("#toast").hide().removeClass("toast-hide")},2e3);return false}var shopCode=$("#"+couponCode).attr("shopcode-info");if($("#"+couponCode).hasClass("current")){ec.order.tmpCoupons.delCode(shopCode,couponCode)}else{ec.order.tmpCoupons.addCode(shopCode,couponCode)}var codeslists=ec.order.tmpCoupons.getCodes(shopCode).join(",");if(codeslists.length<5){$("#"+couponCode).removeClass("current");$("#use_coupon_btn").addClass("disabled");$("#order-roll-coupon .order-roll-detail.disabled").each(function(){if($(this).attr("id")){$(this).removeClass("disabled")}});return}codeslists=ec.order.couponReplace(codeslists);var orderReqJson=$("#order-confirm-form input[name=orderReq]").val();var routingTag=$("#routingTagByCouponID").val();var productId=$("#productIdByCouponID").val();var skuId=$("#skuIdByCouponID").val();var interest=$("#interestByCouponID").val();ec.ui.loading.show({css:{"z-index":9999},maskConfig:{css:{"z-index":9998}}});$.ajax({url:"/order/queryAllUsedCouponList.json",type:"post",dataType:"json",data:{orderReqJson:orderReqJson,routingTag:routingTag,productId:productId,interest:interest,couponCodes:codeslists,shopCode:shopCode,skuId:skuId},timeout:1e4,success:function(json){ec.ui.loading.hide();json=json||{};if(!json.success||json.success==="false"){var codeArray=codeslists.split(",");for(var i=0;i<codeArray.length;i++){$("#"+codeArray[i]).addClass("disabled");$("#"+codeArray[i]).removeClass("current")}alertS(json.msg||"商城火爆销售中，请您稍候再试。");return false}shopCode=json.selfCartInfo.shopCode;$("#eff_couponUlId_"+shopCode).find("li").remove();$("#inva_couponUlId_"+shopCode).find("li").remove();var effectiveList=json.selfCartInfo.effectiveList;var invalidList=json.selfCartInfo.invalidList;var usedCouponCodes=json.selfCartInfo.usedCouponCodes;ec.order.couponListRender(effectiveList,invalidList,usedCouponCodes,shopCode);ec.order.slideUpIntro();$("#use_coupon_btn").removeClass("disabled")},error:function(){ec.ui.loading.hide();alert("商城火爆销售中，请您稍候再试。");return false}})};ec.order.ecboxOpen=function(msg){new ec.box($("#order-confim-box-tpl").val().replace("msg",msg),{boxclass:"ol_box_4",boxid:"show_msg_box",width:700,modal:true,showButton:false,onok:function(box){box.close();ec.order.goBackButton()},oncancel:function(box){box.close();ec.order.goBackButton()}}).open()};ec.order.addressNullTips=function(){var html=[];html.push('<div class="box-content">');html.push('<div class="box-errors-1"><span>请您选择收货地址~</span></div>');html.push('<div class="box-button">');html.push(' <a href="javascript:;" class="box-ok"><span>确定</span></a>');html.push("</div>");html.push("</div>");new ec.box(html.join(" "),{boxid:"address_null_tips",boxclass:"ol_box_4 small",title:"",showButton:false,onopen:function(box){box.setPosition()},onclose:function(){ec.order.goBackButton();$("html,body").animate({scrollTop:$("#order-address-list ul").offset().top-100},100)}}).open()};ec.order.globalNullTips=function(message,callback){var html=[];html.push('<div class="box-content">');html.push('<div class="box-errors-1"><span>'+message+"</span></div>");html.push('<div class="box-button">');html.push(' <a href="javascript:;" class="box-ok"><span>确定</span></a>');html.push("</div>");html.push("</div>");new ec.box(html.join(" "),{boxid:"global_null_tips",boxclass:"ol_box_4 small",title:"",showButton:false,onopen:function(box){box.setPosition()},onclose:function(){if(callback){callback()}}}).open()};function pushPostOrderMsg(){var skuCode=[];var bindId=[];var orderJson=$('input[name="orderReq"]').val();try{orderJson=JSON.parse(orderJson)}catch(e){orderJson={}}for(var i=0;i<orderJson.length;i++){skuCode.push(orderJson[i].itemId+","+orderJson[i].qty);if(orderJson[i].gifts){for(var g=0;g<orderJson[i].gifts.length;g++){skuCode.push(orderJson[i].gifts[g].sbomCode+","+orderJson[i].qty)}}if(orderJson[i].itemType==="P"||orderJson[i].itemType==="DP"){var subs=[orderJson[i].itemId];if(orderJson[i].subOrderItemReqArgs&&orderJson[i].subOrderItemReqArgs.length>0){for(var j=0;j<orderJson[i].subOrderItemReqArgs.length;j++){subs.push(orderJson[i].subOrderItemReqArgs[j].itemId)}}var packageCode=orderJson[i].itemType==="DP"?orderJson[i].itemProp.dp_package_code:orderJson[i].itemProp.package_code;bindId.push(packageCode+","+orderJson[i].qty+";"+subs.join(","))}}ec.dapClick(300040101,{SKUCode:skuCode,packagecode:bindId,click:1})}ec.order.giftMessage=function(){if($("#giftMessageTip").val().length<=100){$("#giftNumTips").text($("#giftMessageTip").val().length)}else{$("#giftNumTips").text(100);$("#giftMessageTip").val($("#giftMessageTip").val().substring(0,100))}};ec.order.unpayBox=function(){var box=new ec.box($("#unpay-order").html(),{boxclass:"ol_box_4  ol_box_noclose",width:700,showButton:false,autoHeight:false});box.open()};ec.order.goPay=function(){if($("#NextPay-Ips").val!=""){$("#goPayDirect").attr({action:"/payment/orderNew",method:"post"});$("#goPayDirect").append('<input type="hidden" name="orderCode" value="'+$("#direct-Ips").val()+'">');gid("goPayDirect").submit()}else{ec.postTo("/payment/orderNew",{orderCode:$("#direct-Ips").val()})}};ec.order.companyValidator=function(val){val=ec.order.invoice.optValidateCompany(val);var limitSize=$("input[id^=invoiceLimitCorp-]").length;var error=$("#invoiceCorpMsg").val();for(var i=0;i<limitSize;i++){if(val===$("#invoiceLimitCorp-"+i).val()){return false}}return true};ec.order.errorCompanyBox=function(){var box=new ec.box($("#erroCompany").html(),{boxclass:"ol_box_4 small",showButton:false,autoHeight:false});box.open()};ec.order.errorCompanyBoxTemp=function(){var box=new ec.box($("#erroCompany").html(),{boxclass:"ol_box_4",showButton:false,autoHeight:false});box.open()};ec.order.taxNumber=function(){var tempVatCode=ec.order.invoice.getAllTaxNumber();if(tempVatCode==""){ec.order.geeTestToEnterPrice()}else{(new ec.ajax).post({url:"/invoice/queryTaxNum.json",data:{taxNum:tempVatCode},timeout:1e4,successFunction:function(json){if(!json.success){json.msg="操作超时，请重试！";ec.showError(json);return}if(json.success){if(json.msg=="noTips"){ec.order.geeTestToEnterPrice()}else{$("#erroCompany").html("");var tempEorrorTaxTips=[];tempEorrorTaxTips.push('<div class="box-prompt01-error"><div class="h"><i></i></div><div class="b">');tempEorrorTaxTips.push('<p class="title tal">'+json.msg+"</p>");tempEorrorTaxTips.push('<div class="box-button">  <a href="javascript:;" class="box-ok"><span>返回修改</span></a> ');tempEorrorTaxTips.push('<a href="javascript:;" class="box-cancel" onclick= "ec.order.geeTestToEnterPrice();"><span>继续提交</span></a> </div>');$("#erroCompany").html(tempEorrorTaxTips.join(""));ec.order.errorCompanyBoxTemp()}}}})}};ec.order.commonPoint=function(json){var huaban_checked_common=$("#huaban-checkbox").attr("checked");var point_checked_common=$("#point-checkbox").attr("checked");if(huaban_checked_common){ec.order.petalAmount=json.cartInfo.petalPay;$("#canUserPetal").html('，使用<span id="huaban-max">'+json.cartInfo.petalNum+'</span>花瓣，抵<b id="point-plus">¥'+parseFloat(json.cartInfo.petalPay).toFixed(2)+"</b>")}else{ec.order.petalAmount=0}ec.order.pointPay=json.cartInfo.pointPay;ec.order.showUsePointArea(point_checked_common,json)};ec.order.geeTestToEnterPrice=function(){var tempValidate=false;if($("input[name='orderReq']").val()!=""){var orderReqLst=JSON.parse($("input[name='orderReq']").val());for(var i=0;i<orderReqLst.length;i++){if(orderReqLst[i].itemType=="I"){tempValidate=true}}}if(tempValidate&&ec.order.showGeetest==1){(new ec.ajax).get({url:"/member/geeTest/get.json?t="+(new Date).getTime(),timeout:1e4,successFunction:function(json){initGeetest({gt:json.gt,challenge:json.challenge,offline:!json.success,new_captcha:true,product:"bind"},function(captchaObj){captchaObj.onReady(function(){console.log("onReady");captchaObj.verify()}).onSuccess(function(){console.log("onSuccess");var result=captchaObj.getValidate();if(!result){return alert("请完成验证")}$.ajax({url:"/member/geeTest/Confirm.json",type:"post",dataType:"json",data:{geetest_challenge:result.geetest_challenge,geetest_validate:result.geetest_validate,geetest_seccode:result.geetest_seccode},success:function(data){if(data.status==="success"){ec.order.invalidSubmitProduct()}else if(data.status==="fail"){return alert("订单提交异常，请刷新页面重试")}else{return alert("订单提交异常，请刷新页面重试")}}})});captchaObj.onError(function(){ec.order.goBackButton();alert("校验失败请重试")});captchaObj.onClose(function(){ec.order.goBackButton()})})}})}else{ec.order.invalidSubmitProduct()}};ec.order.splitOrder=function(){var interest=$("#interestByCouponID").val();var interestType;if(interest&&interest!=""){interestType=interest.split(":")[0]}if($("#order-confirm-form").attr("action").indexOf("/order/createcart")<0){setTimeout(function(){$("#order-confirm-form").submit()},500)}else{$.ajax({url:interestType=="2"?"/order/createCmbLifeOrder.json":"/order/createcart.json",type:"post",data:$("#order-confirm-form").serialize(),dataType:"json",success:function(date){if(interestType=="2"){if(date&&date.ips&&date.ips.redirectUrl&&date.ips.redirectPara){var ipsApi=date.ips.redirectUrl;$.ajax({url:ipsApi,data:date.ips.redirectPara,type:"get",dataType:"jsonp",timeout:8e3,success:function(ipsResponse){var ipsJson=ipsResponse;if(ipsJson&&ipsJson.sdk_paras){try{ipsJson.sdk_paras=JSON.parse(ipsJson.sdk_paras)}catch(e){$("#checkoutSubmit").removeClass("disabled");alert("支付系统繁忙，请稍后再试");return false}}else{$("#checkoutSubmit").removeClass("disabled");alert("支付系统繁忙，请稍后再试");return false}if(!ipsJson.sdk_paras||!ipsJson.sdk_paras.submit_url){$("#checkoutSubmit").removeClass("disabled");alert("支付系统繁忙，请稍后再试");return false}$.ajax({url:"/order/verifyIpsApiTrade.json",type:"post",data:{reqString:JSON.stringify(ipsJson)},dataType:"json",success:function(res){if(res&&res.success){ec.order.showCmbQrcode(ipsJson.sdk_paras.submit_url,ipsJson.sdk_paras.order_code)}else{$("#checkoutSubmit").removeClass("disabled");ec.order.showCmbError(ipsJson.sdk_paras.order_code)}},error:function(){$("#checkoutSubmit").removeClass("disabled");ec.order.showCmbError(ipsJson.sdk_paras.order_code)}})},error:function(){$("#checkoutSubmit").removeClass("disabled");alert("支付系统繁忙，请稍后再试")}})}}else{if(date.payNoOne!="unPay"){if(!date.success){var tempUnsuccessTip="";if(date.code=="6120007"){tempUnsuccessTip="6120007"}else{tempUnsuccessTip="FromCreate"}var validateForm=$("#validateForward");validateForm.append("<input type='hidden' name='errorCode' value='"+tempUnsuccessTip+"'>");validateForm.append("<input type='hidden' name='errorMsg' value='"+date.msg+"'>");validateForm.submit()}else{$("#goPayDirect").attr({action:"/clearPay/order",method:"post"});$("#direct-Ips").val(JSON.stringify(date.ips));$("#goPayDirect").submit()}}else{var orderCodes="";var payOrderInfoList=date.ips.payOrderInfoList;for(var i=0;i<payOrderInfoList.length;i++){orderCodes+=payOrderInfoList[i].orderCode+"|"}var nextOrderAndCash="";var noPayOrderInfoList=date.ips.unPayOrderInfoList;for(var i=0;i<noPayOrderInfoList.length;i++){nextOrderAndCash+=noPayOrderInfoList[i].orderCode+":"+noPayOrderInfoList[i].cashPay+"|"}var tempOrderMsg=[];tempOrderMsg.push('<div class="order-no-list-errors">本次下单商品需拆分订单分开支付，现在支付部分订单，剩余订单请前往“我的订单”进行支付。</div>');tempOrderMsg.push('<div class="order-no-list normal">');tempOrderMsg.push('<div class="order-no-tips01">本次支付部分订单的商品<span>&yen;'+date.nowPayPrice+"</span></div>");for(var i=0;i<payOrderInfoList.length;i++){for(var j=0;j<payOrderInfoList[i].sbomVOs.length;j++){var tempPayProductType;if(payOrderInfoList[i].sbomVOs[j].sbomType=="P"){tempPayProductType="套餐"}else if(payOrderInfoList[i].sbomVOs[j].sbomType=="S6"||payOrderInfoList[i].sbomVOs[j].sbomType=="S1"||payOrderInfoList[i].sbomVOs[j].sbomType=="S15"){tempPayProductType="服务商品"}else if(payOrderInfoList[i].sbomVOs[j].sbomType=="I"){tempPayProductType="内购"}else if(payOrderInfoList[i].sbomVOs[j].sbomType=="J"){tempPayProductType="加价购"}else if(payOrderInfoList[i].sbomVOs[j].sbomType=="DP"){tempPayProductType="搭配"}else{tempPayProductType="单品"}tempOrderMsg.push('<ul class="clearfix"><li>'+tempPayProductType+'</li><li class="p-img">');tempOrderMsg.push('<img alt="'+payOrderInfoList[i].sbomVOs[j].sbomName+'" src="'+ec.mediaPath+payOrderInfoList[i].sbomVOs[j].photoPath+"428_428_"+payOrderInfoList[i].sbomVOs[j].photoName+'"/>');tempOrderMsg.push('</li><li><div class="p-name">'+payOrderInfoList[i].sbomVOs[j].sbomName+"</div> <li>x"+payOrderInfoList[i].sbomVOs[j].quantity+"</li></ul>")}}tempOrderMsg.push('<div class="order-no-tips02">需稍后支付部分订单的商品<span>&yen;'+date.unPayPrice+"</span></div>");for(var i=0;i<noPayOrderInfoList.length;i++){for(var j=0;j<noPayOrderInfoList[i].sbomVOs.length;j++){var tempUnProductType;if(noPayOrderInfoList[i].sbomVOs[j].sbomType=="P"){tempUnProductType="套餐"}else if(noPayOrderInfoList[i].sbomVOs[j].sbomType=="S6"||noPayOrderInfoList[i].sbomVOs[j].sbomType=="S1"||noPayOrderInfoList[i].sbomVOs[j].sbomType=="S15"){tempUnProductType="服务"}else if(noPayOrderInfoList[i].sbomVOs[j].sbomType=="I"){tempUnProductType="内购"}else if(noPayOrderInfoList[i].sbomVOs[j].sbomType=="J"){tempUnProductType="加价购"}else if(noPayOrderInfoList[i].sbomVOs[j].sbomType=="DP"){tempUnProductType="搭配"}else{tempUnProductType="单品"}tempOrderMsg.push('<ul class="clearfix"><li>'+tempUnProductType+'</li><li class="p-img">');tempOrderMsg.push('<img alt="'+noPayOrderInfoList[i].sbomVOs[j].sbomName+'" src="'+ec.mediaPath+noPayOrderInfoList[i].sbomVOs[j].photoPath+"428_428_"+noPayOrderInfoList[i].sbomVOs[j].photoName+'"/>');tempOrderMsg.push('</li><li><div class="p-name">'+noPayOrderInfoList[i].sbomVOs[j].sbomName+"</div> <li>x"+noPayOrderInfoList[i].sbomVOs[j].quantity+"</li></ul>")}}tempOrderMsg.push('</div><div class="box-button"><a href="/member/order" class="box-cancel"><span>返回我的订单</span></a><a href="javascript:;" class="box-sure" onclick="ec.order.goPay()"><span>前往支付</span></a></div>');tempOrderMsg.push('<input name="ips" id="clear-Ips" type="hidden" />');$("#unpay-order").html(tempOrderMsg.join(" "));$("#direct-Ips").valS(orderCodes);$("#NextPay-Ips").valS(nextOrderAndCash);ec.order.unpayBox();$("#checkoutSubmit").removeClass("disabled")}}},error:function(xhr){if([405,597].indexOf(xhr.status)<0)alert("提交失败，请检查地址、发票等各项是否填写准确");$("#checkoutSubmit").removeClass("disabled")}})}};ec.order.goBackButton=function(){$("#checkoutSubmit").removeClass("disabled")};ec.order.couponListRender=function(effectiveList,invalidList,usedCouponCodes,shopCode){var html="";var html2="";var couponStyle="";var couponKind="";var priceLabel="";if(effectiveList!=null&&effectiveList!=""&&effectiveList!=undefined){for(var i=0;i<effectiveList.length;i++){var effCouponInfo=effectiveList[i];var currentInfo="";var disabledInfo="";if(effCouponInfo.ruleType==1&&effCouponInfo.deliveryFree==0){couponStyle="";couponKind="<span>"+effCouponInfo.amount+"</span><strong>优惠券</strong>";priceLabel="<em>&yen;</em>"}else if(effCouponInfo.ruleType==2&&effCouponInfo.deliveryFree==0){couponStyle=" order-roll-discount";couponKind="<span>"+effCouponInfo.discount*10+"</span><b>折</b>";priceLabel=""}else{couponStyle=" order-roll-type";couponKind="<span>免邮券</span>";priceLabel=""}if(usedCouponCodes.indexOf(effCouponInfo.couponCode)!=-1){currentInfo=" current "}if(effCouponInfo.selectable!=true){disabledInfo=" disabled "}html+='<li id="'+effCouponInfo.couponCode+'"  shopcode-info="'+shopCode+'"  name ="effCouponInfo_'+(i+1)+'" index="effCouponInfo_'+(i+1)+'" data="'+effCouponInfo.deliveryFree+"|"+effCouponInfo.couponCode+"|"+effCouponInfo.couponName+"|"+effCouponInfo.amount+'" class="order-roll-detail '+couponStyle+currentInfo+disabledInfo+'" onclick="ec.order.couponSelected(\''+ec.encodeForJS(effCouponInfo.couponCode)+"')\">";html+='<div class="order-roll-info">';html+=priceLabel;html+='<div class="order-roll-price clearfix">';html+=couponKind;html+="</div>";if(effCouponInfo.kind=="2"){html+='<span class="order-roll-tag">叠加劵</span>'}html+='<p title="'+effCouponInfo.couponName+'" class="order-roll-word">'+effCouponInfo.couponName+"</p>";html+="</div>";if(effCouponInfo.couponDes==null){var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html+='<p class="order-roll-explain">使用要求：';html+=des;html+='<a href="javascript:;" class="btn"></a></p>'}else{var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html+='<p class="order-roll-explain">使用要求：';html+=des+"，"+effCouponInfo.couponDes;html+='<a href="javascript:;" class="btn"></a></p>'}}$("#eff_couponUlId_"+shopCode).html(html)}if(invalidList!=null&&invalidList!=""&&invalidList!=undefined){for(var i=0;i<invalidList.length;i++){var effCouponInfo=invalidList[i];if(effCouponInfo.ruleType==1&&effCouponInfo.deliveryFree==0){couponStyle="";couponKind="<span>"+effCouponInfo.amount+"</span><strong>优惠券</strong>";priceLabel="<em>&yen;</em>"}else if(effCouponInfo.ruleType==2&&effCouponInfo.deliveryFree==0){couponStyle=" order-roll-discount";couponKind="<span>"+effCouponInfo.discount*10+"</span><b>折</b>";priceLabel=""}else{couponStyle=" order-roll-type";couponKind="<span>免邮券</span>";priceLabel=""}html2+='<li class="order-roll-detail disabled '+couponStyle+'">';html2+='<div class="order-roll-info">';html2+=priceLabel;html2+='<div class="order-roll-price clearfix">';html2+=couponKind;html2+="</div>";html2+='<p title="'+effCouponInfo.couponName+'" class="order-roll-word">'+effCouponInfo.couponName+"</p>";html2+="</div>";if(effCouponInfo.couponDes==null){var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html2+='<p class="order-roll-explain">使用要求：';html2+=des;html2+='<a href="javascript:;" class="btn"></a></p>'}else{var des=effCouponInfo.beginDate.substring(0,10).split("-").join(".")+" - "+effCouponInfo.endDate.substring(0,10).split("-").join(".");html2+='<p class="order-roll-explain">使用要求：';html2+=des+"，"+effCouponInfo.couponDes;html2+='<a href="javascript:;" class="btn"></a></p>'}}$("#inva_couponUlId_"+shopCode).html(html2)}};ec.load({url:scriptPath+"/common/jquery.qrcode.min.js",type:"js"});ec.order.showCmbQrcode=function(qrTxt,orderNo){var thtml='<div class="payment-zsyh">';thtml+='<div class="title">';thtml+="<span>掌上生活支付</span>";thtml+='<a class="j-kf" href="javascript:;" target="_blank">客服</a>';thtml+="</div>";thtml+='<div class="payment-zsyh-detail">';thtml+='<div class="state">订单提交成功，请您尽快完成支付~</div>';thtml+='<div class="code">';thtml+='<div class="code-detail">';thtml+='<div class="code-img"></div>';thtml+='<p>请使用<span class="red">掌上生活</span>扫码<br>扫描二维码支付</p>';thtml+="</div>";thtml+="</div>";thtml+='<div class="tips">本服务由招商银行提供，需要下载“掌上生活”APP才能支付</div>';thtml+="</div>";thtml+='<div class="box-button">';thtml+="<a onclick=\"ec.postTo('/payment/orderNew', {orderCode:'"+orderNo+'\'});" href="javascript:;" class="box-cancel"><span>更换支付方式</span></a>';thtml+="<a onclick=\"ec.postTo('/member/order/detail', {orderCode:'"+orderNo+'\'});" href="javascript:;" class="box-sure"><span>已完成支付</span></a>';thtml+="</div>";thtml+="</div>";var box=new ec.box(thtml,{boxid:"jb-cmbqrcode",boxclass:"ol_box_4",width:710,height:534,showTitle:false,showButton:false,oncancel:function(){ec.postTo("/payment/orderNew",{orderCode:orderNo});return false}});box.open();$(".j-kf").attr("href",($("#tools-nav-service-robotim-button").attr("href")||"").replace("&from=06","&from=02"));setTimeout(function(){box._box.find(".code-img").qrcode({width:130,height:130,text:qrTxt})},50)};ec.order.showCmbError=function(orderNo){var thtml='<div class="payment-zsyh">';thtml+='<div class="title">';thtml+="<span>掌上生活支付</span>";thtml+='<a class="j-kf" href="javascript:;" target="_blank">客服</a>';thtml+="</div>";thtml+='<div class="payment-zsyh-fail"><p>支付码加载失败，请您点击更换支付方式再试试~</p></div>';thtml+='<div class="box-button">';thtml+="<a onclick=\"ec.postTo('/payment/orderNew', {orderCode:'"+orderNo+'\'});" href="javascript:;" class="box-cancel"><span>更换支付方式</span></a>';thtml+="<a onclick=\"ec.postTo('/member/order/detail', {orderCode:'"+orderNo+'\'});" href="javascript:;" class="box-sure"><span>查看订单</span></a>';thtml+="</div>";thtml+="</div>";var box=new ec.box(thtml,{boxid:"jb-cmberror",boxclass:"ol_box_4",width:710,height:448,showTitle:false,showButton:false,oncancel:function(){ec.postTo("/payment/orderNew",{orderCode:orderNo});return false}});box.open();$(".j-kf").attr("href",($("#tools-nav-service-robotim-button").attr("href")||"").replace("&from=06","&from=02"))};