ec.load("ajax");ec.pkg("ec.order.invoice");ec.order.invoice.optValidateCompany=function(str){return str.replace(/(^\s*)|(\s*$)/g,"").replace(/（/g,"(").replace(/）/g,")")};ec.order.invoice.optCompany=function(str){return str.replace(/(^\s*)|(\s*$)/g,"")};$.extend(ec.form.validator.defaults,{errorClass:"error",autoFocus:false,errorFunction:function(obj,options){var css="report-errors",msg=options.msg[options.type]||options.msg["default"];msg=msg.length<=0?"&nbsp;":msg;switch(options.type){case"require":css="report-errors";break;case"invoiceCompany":if(""!=msg){if(msg.indexOf("$name")!=-1){var nameRegex=/\$name/gi;msg=msg.replace(nameRegex,obj.val())}}break}msg=$("<div/>").textS(msg).html();if(options.msg_ct){$(options.msg_ct).addClass("report-errors").html(ec.autoEncodeAttr(msg))}else{var id=(obj.attr("id")||obj.attr("name"))+"-msg";$("#"+id).remove();obj.after("<div id='"+id+"' class='report-errors "+css+"'>"+ec.autoEncodeAttr(msg)+"</div>")}if(options.autoFocus)obj.focus()},successFunction:function(obj,options){if(!$(options.msg_ct).hasClass("filter")){if(options.msg_ct){$(options.msg_ct).html("").removeClass("label-error")}else{$("#"+(obj.attr("id")||obj.attr("name"))+"-msg").remove()}}}});ec.form.validator.register("invoiceCompany",function(val){val=ec.order.invoice.optValidateCompany(val);var limitSize=$("input[id^=invoiceLimitCorp-]").length;var error=$("#invoiceCorpMsg").val();for(var i=0;i<limitSize;i++){if(val===$("#invoiceLimitCorp-"+i).val()){return false}}return true});ec.form.validator.register("lengthOfChar",function(n,m){if(m.allowEmpty){return true}if(!(m.min||m.max)){h("length","need parameter of 'min' or 'max'!");return false}var l=n.replace(/[^\x00-\xff]/g,"rr").len();if(m.min&&l<m.min){return false}if(m.max&&l>m.max){return false}return true});var invoiceFlag=true;$("#vatInvoice-companyName").live("compositionstart",function(){invoiceFlag=false});$("#vatInvoice-companyName").live("compositionend",function(){invoiceFlag=true});var invoiceXhr;ec.order.invoice.autoFillForm=function(){$(".invoice-new-company").remove();clearTimeout(timer);if(invoiceXhr){invoiceXhr.abort()}var oldVal=$("#vatInvoice-companyName").val();var timer=setTimeout(function(){var currentVal=$("#vatInvoice-companyName").val();if(invoiceFlag&&oldVal==currentVal&&oldVal!=""&&currentVal.match(/[\u4E00-\u9FA5]+/g)){invoiceXhr=$.ajax({url:domainMain+"/member/queryInvoice.json",dataType:"json",timeout:3e3,data:{invoiceName:currentVal.replace(/[^\u4E00-\u9FA5]+/g,"")},success:function(res){$(".invoice-new-company").remove();if(res.invoiceInfo){var dataInfo=JSON.parse(res.invoiceInfo.transHtmlAttribute()).datas;if(dataInfo==null||dataInfo=="undefined"||dataInfo==""){return}var companyList=JSON.parse(res.invoiceInfo.transHtmlAttribute()).datas.slice(0,5);if(companyList!=null&&companyList.length){$("#vatInvoice-companyName").after('<div class="invoice-new-company"><ul></ul><div class="invoice-new-company-btn"><a href="javascript:;">关闭</a></div></div>');for(var i=0;i<companyList.length;i++){$(".invoice-new-company ul").append('<li><a href="javascript:;">'+ec.autoEncodeAttr(companyList[i].name)+"</a></li>")}$.each(companyList,function(index,item){$(".invoice-new-company li a").eq(index).click(function(){$(".invoice-new-company").remove();$("#vatInvoice-companyName").valS(item.name).removeClass("error").next().text("");$("#vatInvoice-taxpayerIdentityNum").valS(item.taxNo).removeClass("error").next().text("");$("#vatInvoice-registeredAddress").valS(item.address).removeClass("error").next().text("");$("#vatInvoice-registeredTelephone").valS(item.telephone).removeClass("error").next().text("");$("#vatInvoice-depositBank").valS(item.buyerBankAcc).removeClass("error").next().text("");$("#vatInvoice-bankAccount").valS(item.buyerBankNum).removeClass("error").next().text("")})})}}},error:function(err){}})}},500);$("#order-invoice-edit,.ol_box_mask").live("click",function(e){$(".invoice-new-company").remove()})};ec.order.invoice.select=function(type){UIController.changeTitleType(type)};ec.order.invoice.popup={box:{},list:{},edit:function(shopCode){$("#myAddress-add-new-box").remove();$("#myAddress-edit-new-box").remove();ec.address.processType="1";UIController.showBox(shopCode);ec.address.bindSeelctEvent(1)},select:function(type){UIController.changeTab($("#order-shopCode").val(),type,1)},save:function(type){UIController.checkViewBoxAndToCache($("#order-shopCode").val())},validateNormal:function(form){var _vb=ec.form.validator.bind;_vb(form.find("#invoice-normal-company"),{type:["require","invoiceForbidChar","invoiceCompany","lengthOfChar"],validOnChange:true,allowEmpty:false,min:2,max:100,msg_ct:form.find("#normalCompanyError"),msg:{require:"请输入单位名称",invoiceForbidChar:"不能含有非法字符",invoiceCompany:$("#invoiceCorpMsg").val(),lengthOfChar:"单位名称只支持2~100位中英文字符"}});_vb(form.find("#invoice-normal-taxpayerIdentityNum"),{type:["regex"],validOnChange:true,regex:/^(?!^[A-Z]+$)[0-9A-Z]{15}$|^(?!^[A-Z]+$)[0-9A-Z]{18}$|^(?!^[A-Z]+$)[0-9A-Z]{17}$|^(?!^[A-Z]+$)[0-9A-Z]{20}$/,msg_ct:form.find("#invoice-normal-taxpayerIdentityNum-error"),msg:{regex:"纳税人识别号为15，17，18，20位的数字或大写字母+数字"}})},validateElectronic:function(form,shopCode){var invoiceConfig=InvoiceManager.invoiceCfgList[shopCode];var _vb=ec.form.validator.bind;_vb(form.find("#invoice-electronic-company"),{type:["require","lengthOfChar","invoiceForbidChar","invoiceCompany"],validOnChange:true,allowEmpty:false,min:2,max:100,msg_ct:form.find("#elecCompanyError"),msg:{lengthOfChar:"单位名称只支持2~100位中英文字符",invoiceForbidChar:"不能含有非法字符",require:"请输入单位名称",invoiceCompany:$("#invoiceCorpMsg").val()}});_vb(form.find("#invoice-electronic-taxpayerIdentityNum"),{type:["require","regex"],validOnChange:true,regex:/^(?!^[A-Z]+$)[0-9A-Z]{15}$|^(?!^[A-Z]+$)[0-9A-Z]{17}$|^(?!^[A-Z]+$)[0-9A-Z]{18}$|^(?!^[A-Z]+$)[0-9A-Z]{20}$/,msg_ct:form.find("#invoice-electronic-taxpayerIdentityNum-error"),msg:{regex:"纳税人识别号为15，17，18，20位的数字或大写字母+数字",require:"请填写纳税人识别号"}});if(invoiceConfig&&invoiceConfig.isRequireEmailCheck){_vb(form.find("#invoice-electronic-email-person"),{type:["regex"],validOnChange:true,regex:/^(\w)+(\.\w+)*@(\w)+((\.[a-zA-Z]+)+)$/,msg_ct:form.find("#elecEmailError-person"),msg:{regex:"邮箱格式不正确"}});_vb(form.find("#invoice-electronic-email-unit"),{type:["regex"],validOnChange:true,regex:/^(\w)+(\.\w+)*@(\w)+((\.[a-zA-Z]+)+)$/,msg_ct:form.find("#elecEmailError-unit"),msg:{regex:"邮箱格式不正确"}})}if(invoiceConfig&&invoiceConfig.isRequirePhoneCheck){_vb(form.find("#invoice-electronic-person-phone"),{type:["mobile","require"],validOnChange:true,msg_ct:form.find("#elecPhoneError-person"),msg:{default:"请填写正确的11位手机号码，例如：13XXXXXXXXX",require:"请输入电子普通发票的接收手机"}});_vb(form.find("#invoice-electronic-unit-phone"),{type:["mobile","require"],validOnChange:true,msg_ct:form.find("#elecPhoneError-unit"),msg:{default:"请填写正确的11位手机号码，例如：13XXXXXXXXX",require:"请输入电子普通发票的接收手机"}})}else{if(invoiceConfig&&invoiceConfig.isRequireEmailCheck){_vb(form.find("#invoice-electronic-email-person"),{type:["require"],validOnChange:true,msg_ct:form.find("#elecEmailError-person"),msg:{require:"请输入电子普通发票的接收邮箱"}});_vb(form.find("#invoice-electronic-email-unit"),{type:["require"],validOnChange:true,msg_ct:form.find("#elecEmailError-unit"),msg:{require:"请输入电子普通发票的接收邮箱"}})}_vb(form.find("#invoice-electronic-person-phone"),{type:["mobile"],validOnChange:true,msg_ct:form.find("#elecPhoneError-person"),msg:{default:"请填写正确的11位手机号码，例如：13XXXXXXXXX"}});_vb(form.find("#invoice-electronic-unit-phone"),{type:["mobile"],validOnChange:true,msg_ct:form.find("#elecPhoneError-unit"),msg:{default:"请填写正确的11位手机号码，例如：13XXXXXXXXX"}})}ec.form.input.label(form.find("#vatInvoice-mobile"),"请输入11位手机号码")},validatePerson:function(form){var _vb=ec.form.validator.bind;_vb(form.find("#vatInvoice-consignee"),{type:["require","lengthOfChar","regex"],validOnChange:true,regex:/^[\uFF21-\uFF3A\uFF41-\uFF5A\u4E00-\u9FA5\s\u3000A-Za-z]+$/,allowEmpty:false,min:2,max:20,msg_ct:form.find("#vatInvoice-consignee-error"),msg:{lengthOfChar:"专用发票收票人只支持2-20位中英文字符",regex:"收货人只能填写中文和英文字符",require:"请填写收货人"}});_vb(form.find("#vatInvoice-address"),{type:["require","length","forbidChar2"],validOnChange:true,max:100,msg_ct:form.find("#vatInvoice-address-error"),msg:{forbidChar2:"不能含有非法字符",length:"详细地址最长为100个字符，一个汉字为两个字符",require:"请填写详细地址"}});_vb(form.find("#vatInvoice-mobile"),{type:["mobile","require"],validOnChange:true,msg_ct:form.find("#vatInvoice-mobile-error"),msg:{default:"请填写正确的11位手机号码，例如：13XXXXXXXXX",require:"请填写手机号码"}});ec.form.input.label(form.find("#vatInvoice-mobile"),"请输入11位手机号码")},validateCompany:function(form){var _vb=ec.form.validator.bind;_vb(form.find("#vatInvoice-companyName"),{type:["require","lengthOfChar","invoiceForbidChar","invoiceCompany"],validOnChange:true,allowEmpty:false,min:2,max:100,msg_ct:form.find("#vatInvoice-companyName-error"),msg:{invoiceForbidChar:"不能含有非法字符",lengthOfChar:"专用单位名称只支持2~100位中英文字符",require:"请填写单位名称",invoiceCompany:$("#invoiceCorpMsg").val()}});_vb(form.find("#vatInvoice-taxpayerIdentityNum"),{type:["require","regex"],validOnChange:true,regex:/^(?!^[A-Z]+$)[0-9A-Z]{15}$|^(?!^[A-Z]+$)[0-9A-Z]{17}$|^(?!^[A-Z]+$)[0-9A-Z]{18}$|^(?!^[A-Z]+$)[0-9A-Z]{20}$/,msg_ct:form.find("#vatInvoice-taxpayerIdentityNum-error"),msg:{regex:"纳税人识别号为15，17，18，20位的数字或大写字母+数字",require:"请填写纳税人识别号"}});_vb(form.find("#vatInvoice-registeredAddress"),{type:["require","length","forbidChar2"],validOnChange:true,max:80,msg_ct:form.find("#vatInvoice-registeredAddress-error"),msg:{forbidChar2:"不能含有非法字符",length:"注册地址最长为80个字符，一个汉字为两个字符",require:"请填写注册地址"}});_vb(form.find("#vatInvoice-registeredTelephone"),{type:["require","regex"],validOnChange:true,regex:/^[-\d]{10,20}$/,min:10,max:20,msg_ct:form.find("#vatInvoice-registeredTelephone-error"),msg:{require:"请填写注册电话",regex:"注册电话只能是数字和-，最少10位，最长20位"}});_vb(form.find("#vatInvoice-depositBank"),{type:["require","length","forbidChar"],validOnChange:true,max:100,msg_ct:form.find("#vatInvoice-depositBank-error"),msg:{forbidChar:"不能含有非法字符",length:"开户银行最长为100个字符，一个汉字为两个字符",require:"请填写开户银行"}});_vb(form.find("#vatInvoice-bankAccount"),{type:["require","regex"],validOnChange:true,regex:/^[0-9]{6,50}$/,msg_ct:form.find("#vatInvoice-bankAccount-error"),msg:{regex:"银行账户为大于5位小于等于50位的数字",require:"请填写银行账户"}})}};UcInterface={newShopInvoice:function(shopCode,userInvoiceInfoVO){var cached={};var uclist=userInvoiceInfoVO.invoiceInfoVOList||[];var lastlist=userInvoiceInfoVO.lastInvoiceInfo||[];var titleTypeFromPage=$("#order-titleType"+shopCode).val();if(titleTypeFromPage=="50"){titleTypeFromPage="2"}for(var i=0;i<lastlist.length;i++){if(lastlist[i].carrierCode==shopCode){if(lastlist[i].invoiceType==titleTypeFromPage){cached.lastInvoiceType=lastlist[i].invoiceType;cached.lastInvoiceTitleType=lastlist[i].titleType;break}}else{cached.lastInvoiceType=titleTypeFromPage;cached.lastInvoiceTitleType="1"}}for(var i=0;i<uclist.length;i++){var invoice=uclist[i];if(invoice.carrierCode==shopCode){if(invoice.invoiceType=="1"){cached.normal=invoice.company;cached.normalTaxpayerIdentityNum=invoice.taxpayerId;if(cached.normal==null||cached.normal.length<=0){if(invoice.invoiceType==titleTypeFromPage){cached.lastInvoiceTitleType="1"}}}if(invoice.invoiceType=="2"||invoice.invoiceType=="50"){cached.electronic=invoice.company;cached.electronicTaxpayerIdentityNum=invoice.taxpayerId;if(cached.electronic==null||cached.electronic.length<=0){if(invoice.invoiceType==titleTypeFromPage){cached.lastInvoiceTitleType="1"}}cached.electronicSendWayPhoneP=invoice.recvMobile;cached.electronicSendWayEmailP=invoice.recvEmail;cached.electronicSendWayPhoneU=invoice.recvMobile;cached.electronicSendWayEmailU=invoice.recvEmail}if(invoice.invoiceType=="3"){cached.vat={};cached.vat.taxpayerIdentityNum=invoice.taxpayInvoiceInfoVO.taxpayerId;cached.vat.registeredAddress=invoice.taxpayInvoiceInfoVO.regAddress;cached.vat.registeredTelephone=invoice.taxpayInvoiceInfoVO.regTelephone;cached.vat.depositBank=invoice.taxpayInvoiceInfoVO.bank;cached.vat.bankAccount=invoice.taxpayInvoiceInfoVO.bankAccount;cached.vat.companyName=invoice.company;cached.vat.consignee=invoice.taxpayInvoiceInfoVO.checkTaker;cached.vat.province=invoice.taxpayInvoiceInfoVO.takerProvince;cached.vat.city=invoice.taxpayInvoiceInfoVO.takerCity;cached.vat.district=invoice.taxpayInvoiceInfoVO.takerDistrict;cached.vat.street=invoice.taxpayInvoiceInfoVO.takerStreet;cached.vat.address=invoice.taxpayInvoiceInfoVO.takerAddress;cached.vat.mobile=invoice.taxpayInvoiceInfoVO.takerMobile;cached.vat.zipcode=invoice.taxpayInvoiceInfoVO.takerZipcode}}}return cached},update2UC:function(cached){var lastInvoice={};lastInvoice.invoiceType=cached.lastInvoiceType;lastInvoice.titleType=cached.lastInvoiceTitleType;lastInvoice.carrierCode=cached.shopCode;if(cached.lastInvoiceType=="1"){lastInvoice.company=cached.normal;lastInvoice.taxpayerId=cached.normalTaxpayerIdentityNum}if(cached.lastInvoiceType=="2"){lastInvoice.company=cached.electronic;lastInvoice.taxpayerId=cached.electronicTaxpayerIdentityNum;if(cached.lastInvoiceTitleType=="1"){lastInvoice.recvMobile=cached.electronicSendWayPhoneP;lastInvoice.recvEmail=cached.electronicSendWayEmailP}else{lastInvoice.recvMobile=cached.electronicSendWayPhoneU;lastInvoice.recvEmail=cached.electronicSendWayEmailU}}if(cached.lastInvoiceType=="3"){lastInvoice.checkTaker=cached.vat.consignee;lastInvoice.takerProvince=cached.vat.province;lastInvoice.takerCity=cached.vat.city;lastInvoice.takerDistrict=cached.vat.district;lastInvoice.takerStreet=cached.vat.street;lastInvoice.takerAddress=cached.vat.address;lastInvoice.takerMobile=cached.vat.mobile;lastInvoice.takerZipcode=cached.vat.zipcode;lastInvoice.company=cached.vat.companyName;lastInvoice.taxpayerId=cached.vat.taxpayerIdentityNum;lastInvoice.regAddress=cached.vat.registeredAddress;lastInvoice.regTelephone=cached.vat.registeredTelephone;lastInvoice.bankAccount=cached.vat.bankAccount;lastInvoice.bank=cached.vat.depositBank}var data_s={userId:ec.util.cookie.get("uid"),invoiceType:lastInvoice.invoiceType,TitleType:lastInvoice.titleType,company:lastInvoice.company,taxpayerId:lastInvoice.taxpayerId};if($("#invoice_click_2").hasClass("current")){if(cached.lastInvoiceTitleType=="1"){data_s.recvMobile=cached.electronicSendWayPhoneP;data_s.recvEmail=cached.electronicSendWayEmailP}else{data_s.recvMobile=cached.electronicSendWayPhoneU;data_s.recvEmail=cached.electronicSendWayEmailU}}if($("#invoice_click_3").hasClass("current")){var taxpayInvoiceInfoVO={taxpayerId:lastInvoice.taxpayerId,bank:lastInvoice.bank,bankAccount:lastInvoice.bankAccount,regAddress:lastInvoice.regAddress,regTelephone:lastInvoice.regTelephone,checkTaker:lastInvoice.checkTaker,takerProvince:lastInvoice.takerProvince,takerCity:lastInvoice.takerCity,takerDistrict:lastInvoice.takerDistrict,takerStreet:lastInvoice.takerStreet,takerAddress:lastInvoice.takerAddress,takerMobile:lastInvoice.takerMobile};data_s.taxpayInvoiceInfoVO=JSON.stringify(taxpayInvoiceInfoVO)}data_s.carrierCode=$("#order-shopCode").val();$.ajax({type:"post",url:openApiDomain+"/uc/invoice/updateInvoiceInfo.json",dataType:"json",data:JSON.stringify(data_s),timeout:1e4,beforeSend:function(xhr){xhr.withCredentials=true},success:function(){}})},queryUC:function(shopCodeList,invoiceList,callback){$.ajax({url:openApiDomain+"/uc/invoice/queryInvoiceList.json",method:"post",dataType:"json",timeout:1e4,beforeSend:function(xhr){xhr.withCredentials=true},data:{userId:ec.util.cookie.get("uid")},success:function(json){if(json.resultCode=="200000"&&json.data){for(var i=0;i<shopCodeList.length;i++){var code=shopCodeList[i];invoiceList[code]=UcInterface.newShopInvoice(code,json.data)}if(callback){callback()}}}})}};UIController={showBox:function(shopCode){$("#order-shopCode").valS(shopCode);ec.order.invoice.popup.box=new ec.box($("#invoice-edit-box").val(),{boxid:"order-invoice-edit",boxclass:"ol_box_4",title:'发票信息<em style="font-size: 14px;color: #BBBBBB;"></em>',width:700,showButton:false,onopen:function(box){InvoiceManager.queryCfg(shopCode);UIController.cacheToBoxView(InvoiceManager.getInvoice(shopCode));ec.order.invoice.popup.validatePerson($("#vatinvoice-person-form"));ec.order.invoice.popup.validateCompany($("#vatinvoice-company-form"));ec.order.invoice.popup.validateNormal($("#invoice-normal-form"));ec.order.invoice.popup.validateElectronic($("#invoice-electronic-form"),shopCode);ec.order.invoice.popup.validateElectronic($("#invoice-electronic-form-person"),shopCode);box.setPosition()}}).open()},initBoxForDirectCommit:function(shopCode){$("#order-shopCode").valS(shopCode);ec.order.invoice.popup.box=new ec.box($("#invoice-edit-box").val(),{boxid:"order-invoice-edit",boxclass:"ol_box_4",title:'发票信息<em style="font-size: 14px;color: #BBBBBB;"></em>',width:700,showButton:false});InvoiceManager.queryCfg(shopCode);UIController.cacheToBoxView(InvoiceManager.getInvoice(shopCode))},disableTab:function(shopCode){for(var i=0;i<4;i++){if(InvoiceManager.isUneffective(shopCode,i)){$("#invoice_click_"+i).addClass("disabled");$("#invoice_click_"+i).attr("dis-flag","1");var disabledText="订单包含不支持开"+$("#invoice_click_"+i).html().replace('<em class="a-tip"></em>',"")+"的商品。";$("#invoice_click_"+i).attr("title",disabledText);switch(i){case 0:break;case 1:$("#invoice-info-normal").find("input").each(function(){$(this).attr("disabled","disabled")});$("#invoice-info-normal").find("i").each(function(){$(this).removeAttr("onclick");if($(this).attr("class")=="icon-radio-normal"){$(this).addClass("disabled")}});break;case 2:$("#invoice-info-electronic").find("input").each(function(){$(this).attr("disabled","disabled")});$("#invoice-info-electronic").find("i").each(function(){$(this).removeAttr("onclick");if($(this).attr("class")=="icon-radio-normal"){$(this).addClass("disabled")}});break;case 3:$("#invoice-info-add").find("input").each(function(){$(this).attr("disabled","disabled")});$("#current-address").parent().addClass("disabled");$("#current-address").unbind("click");break;default:break}}}},maskTab:function(shopCode){$("#invoice_click_1").hide();$("#invoice_click_2").hide();$("#invoice_click_3").hide();$("#invoice_click_0").hide();if(InvoiceManager.isEffective(shopCode,"1")){$("#invoice_click_1").show()}if(InvoiceManager.isEffective(shopCode,"2")){$("#invoice_click_2").show()}if(InvoiceManager.isEffective(shopCode,"3")){$("#invoice_click_3").show()}if(InvoiceManager.isEffective(shopCode,"0")){$("#invoice_click_0").show()}},changeTab:function(shopCode,invoiceType,titleType){if(InvoiceManager.isEffective(shopCode,"1")&&invoiceType==1){if($("#invoice_click_1").attr("dis-flag")!="0"){return}$("#invoice_click_1").attr("class","current");$("#invoice_click_2").removeClass("current");$("#invoice_click_3").removeClass("current");$("#invoice_click_0").removeClass("current");$("#invoice-info-normal").removeClass("hide");$("#invoice-info-electronic").addClass("hide");$("#invoice-info-notuse").addClass("hide");$("#invoice-info-add").addClass("hide");$("#invoice_save_step").show();$("#invoice_return_step").hide();$("#invoice_next_step").hide();$("#invoice_mid_step").hide();$("#invoiceMemoText1,#invoiceMemoText2,#invoiceMemoText3,#invoiceMemoText0").hide();if($("#invoiceMemoText1").html()){$("#invoiceMemoText1").show();$("#invoiceMemoText1").parent().show()}else{$("#invoiceMemoText1").parent().hide()}$("#invoiceTitle-elecPerson").addClass("icon-radio");$("#invoice-electronic-form").hide();if(titleType=="1"){$("#invoiceTitle-normalPerson").addClass("icon-radio");$("#invoiceTitle-normalCompany").removeClass("icon-radio");$("#invoice-normal-form").hide()}else{$("#invoiceTitle-normalPerson").removeClass("icon-radio");$("#invoiceTitle-normalCompany").addClass("icon-radio");$("#invoice-normal-form").show()}if(InvoiceManager.isUneffective(shopCode,1)){$("#invoice_save_step").hide();var disabledText="订单包含不支持开"+$("#invoice_click_1").html().replace('<em class="a-tip"></em>',"")+"的商品。";$("#invoice-unsupport-tips").html(ec.autoEncodeAttr(disabledText));$("#invoice-unsupport-tips").removeClass("hide")}else{$("#invoice-unsupport-tips").html("");$("#invoice-unsupport-tips").addClass("hide")}}if(InvoiceManager.isEffective(shopCode,"2")&&invoiceType==2){if($("#invoice_click_2").attr("dis-flag")!="0"){return}$("#invoice_click_2").attr("class","current");$("#invoice_click_1").removeClass("current");$("#invoice_click_3").removeClass("current");$("#invoice_click_0").removeClass("current");$("#invoice-info-normal").addClass("hide");$("#invoice-info-electronic").removeClass("hide");$("#invoice-info-notuse").addClass("hide");$("#invoice-info-add").addClass("hide");$("#invoice_save_step").show();$("#invoice_return_step").hide();$("#invoice_next_step").hide();$("#invoice_mid_step").hide();if(!$("#MoreUnSelfSendWay").hasClass("hide")){$("#MoreUnSelfSendWay").addClass("hide")}$("#invoiceMemoText1,#invoiceMemoText2,#invoiceMemoText3,#invoiceMemoText0").hide();if($("#invoiceMemoText2").html()){$("#invoiceMemoText2").show();$("#invoiceMemoText2").parent().show()}else{$("#invoiceMemoText2").parent().hide()}$("#sendWay-person").hide();$("#invoiceTitle-normalPerson").addClass("icon-radio");$("#invoice-normal-form").hide();if(titleType=="1"){$("#invoiceTitle-elecPerson").addClass("icon-radio");$("#invoiceTitle-elecCompany").removeClass("icon-radio");$("#invoice-electronic-form").hide()}else{$("#invoiceTitle-elecPerson").removeClass("icon-radio");$("#invoiceTitle-elecCompany").addClass("icon-radio");$("#invoice-electronic-form").show()}var noUsedInvoiceFromPms=InvoiceManager.isUneffective(shopCode,2);if(noUsedInvoiceFromPms){$("#invoice_save_step").hide();var disabledText="订单包含不支持开"+$("#invoice_click_2").html().replace('<em class="a-tip"></em>',"")+"的商品。";$("#invoice-unsupport-tips").html(ec.autoEncodeAttr(disabledText));$("#invoice-unsupport-tips").removeClass("hide")}else{$("#invoice-unsupport-tips").html("");$("#invoice-unsupport-tips").addClass("hide")}$("#showPhone-person-content").hide();$("#showPhone-unit-content").hide();$("#showEmail-person-content").hide();$("#showEmail-unit-content").hide();if(!noUsedInvoiceFromPms&&shopCode!="VMALL-HUAWEIDEVICE"){if(InvoiceManager.invoiceCfgList[shopCode]!=null){if(InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode!=null&&InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode.length>0){var sendWayList=InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode;for(var i=0;i<sendWayList.length;i++){if(sendWayList[i]=="P"){$("#showPhone-person-content").show();$("#showPhone-unit-content").show();$("#showEmail-person-content label span").html("&nbsp");$("#showEmail-unit-content label span").html("&nbsp")}else{$("#showEmail-person-content").show();$("#showEmail-unit-content").show()}}if(titleType=="1"){$("#sendWay-person").show()}}}}}if(InvoiceManager.isEffective(shopCode,"0")&&invoiceType==0){if($("#invoice_click_0").attr("dis-flag")!="0"){return}$("#invoice_click_0").attr("class","current");$("#invoice_click_1").removeClass("current");$("#invoice_click_2").removeClass("current");$("#invoice_click_3").removeClass("current");$("#invoice-info-normal").addClass("hide");$("#invoice-info-electronic").addClass("hide");$("#invoice-info-notuse").removeClass("hide");$("#invoice-info-add").addClass("hide");$("#invoice_save_step").show();$("#invoice_return_step").hide();$("#invoice_next_step").hide();$("#invoice_mid_step").hide();$("#invoiceMemoText1,#invoiceMemoText2,#invoiceMemoText3,#invoiceMemoText0").hide();$("#invoiceMemoText0").hide();if($("#invoiceMemoText0").html()){$("#invoiceMemoText0").show();$("#invoiceMemoText0").parent().show()}else{$("#invoiceMemoText0").parent().hide()}ec.order.invoice.select(0);if(InvoiceManager.isUneffective(shopCode,0)){$("#invoice_save_step").hide();var disabledText="订单包含不支持开"+$("#invoice_click_0").html().replace('<em class="a-tip"></em>',"")+"的商品。";$("#invoice-unsupport-tips").html(ec.autoEncodeAttr(disabledText));$("#invoice-unsupport-tips").removeClass("hide")}else{$("#invoice-unsupport-tips").html("");$("#invoice-unsupport-tips").addClass("hide")}}if(InvoiceManager.isEffective(shopCode,"3")&&invoiceType==3){if($("#invoice_click_3").attr("dis-flag")!="0"){return}$("#invoice_click_3").attr("class","current");$("#invoice_click_1").removeClass("current");$("#invoice_click_2").removeClass("current");$("#invoice_click_0").removeClass("current");$("#invoice-info-normal").addClass("hide");$("#invoice-info-electronic").addClass("hide");$("#invoice-info-notuse").addClass("hide");$("#invoice-info-add").removeClass("hide");$("#addTitle").show();$("#invoice-company").removeClass("hide");$("#invoice-person").addClass("hide");$("#vat-step-1").addClass("current");$("#vat-step-2").removeClass("current");if(!$("#specialInvoiceMidPage").hasClass("hide")){$("#specialInvoiceMidPage").addClass("hide")}$("#invoice_return_step").hide();$("#invoice_mid_step").hide();$("#invoice_next_step").show();$("#invoice_save_step").hide();if(InvoiceManager.isUneffective(shopCode,3)){$("#invoice_next_step").hide();var disabledText="订单包含不支持开"+$("#invoice_click_3").html().replace('<em class="a-tip"></em>',"")+"的商品。";$("#invoice-unsupport-tips").html(ec.autoEncodeAttr(disabledText));$("#invoice-unsupport-tips").removeClass("hide")}else{$("#invoice-unsupport-tips").html("");$("#invoice-unsupport-tips").addClass("hide")}$("#invoiceMemoText1,#invoiceMemoText2,#invoiceMemoText3,#invoiceMemoText0").hide();if($("#invoiceMemoText3").html()){$("#invoiceMemoText3").show();$("#invoiceMemoText3").parent().show()}else{$("#invoiceMemoText3").parent().hide()}$("#invoiceTitle-normalPerson").addClass("icon-radio");$("#invoiceTitle-normalCompany").removeClass("icon-radio");$("#invoice-normal-form").hide();$("#invoiceTitle-elecPerson").addClass("icon-radio");$("#invoiceTitle-elecCompany").removeClass("icon-radio");$("#invoice-electronic-form").hide()}if(InvoiceManager.isEffective(shopCode,"3")&&invoiceType==7){if(!ec.form.validator($("#vatinvoice-company-form"),true)){return}$("#invoice_next_step").removeAttr("typePage");$("#invoice-company").addClass("hide");$("#specialInvoiceMidPage").removeClass("hide");$("#addTitle").hide();$("#invoiceTips").hide();$("#invoice_next_step").hide();$("#invoice_mid_step").show()}if(InvoiceManager.isEffective(shopCode,"3")&&invoiceType==4){if(!ec.form.validator($("#vatinvoice-company-form"),true)){return}if(!$("#specialInvoiceMidPage").hasClass("hide")){$("#specialInvoiceMidPage").addClass("hide")}$("#addTitle").show();$("#invoice_mid_step").hide();$("#invoiceTips").show();$("#invoice-info-add").removeClass("hide");$("#invoice-company").addClass("hide");$("#invoice-person").removeClass("hide");$("#vat-step-1").removeClass("current");$("#vat-step-2").addClass("current");$("#invoice_return_step").show();$("#invoice_save_step").show();$("#invoice_next_step").hide();if(InvoiceManager.isUneffective(shopCode,3)){$("#invoice_save_step").hide()}}if(InvoiceManager.isEffective(shopCode,"3")&&invoiceType==5){if(!ec.form.validator($("#vatinvoice-person-form"),true)){return}$("#invoice-info-add").removeClass("hide");$("#invoice-company").removeClass("hide");$("#invoice-person").addClass("hide");$("#vat-step-1").addClass("current");$("#vat-step-2").removeClass("current");$("#invoice_return_step").hide();$("#invoice_save_step").hide();$("#invoice_next_step").show()}UIController.disableTab(shopCode)},checkViewBoxAndToCache:function(shopCode){if($("#invoice_click_3").attr("class")=="current"){var district=$("#vatinvoice-person-form").find("input[name=districtG]").attr("value");var street=$("#vatinvoice-person-form").find("input[name=streetG]").attr("value");if(!street){ec.address.queryData(ec.address.parseUrl(children_url,district),true,0,function(json){if(!json||!json.data||json.data.length<1){$("#vatInvoice-myAddress-error").removeClass("report-errors");$("#vatInvoice-myAddress-error").hide();UIController.viewBoxToCache(shopCode);return}$("#vatInvoice-myAddress-error").addClass("report-errors");$("#vatInvoice-myAddress-error").text("请选择完整的地区信息");$("#vatInvoice-myAddress-error").show()});return}}UIController.viewBoxToCache(shopCode)},cacheToBoxView:function(cachedInvoice){var invoiceCfg=InvoiceManager.invoiceCfgList[cachedInvoice.shopCode];if(invoiceCfg){$("#invoiceMemoText1").html(invoiceCfg.paperMemo);$("#invoiceMemoText2").html(invoiceCfg.electronicMemo);$("#invoiceMemoText3").html(invoiceCfg.vatMemo);$("#invoiceMemoText0").html(invoiceCfg.noInvoiceMemo)}$("#invoice-address-detail").append('<th><span class="red">*</span><label>详细地址</label></th><td><input id="vatInvoice-address" type="text" class="invoice-new-text"><div id="vatInvoice-address-error"></div></td>');$("#invoice-normal-company").valS(cachedInvoice.normal);$("#invoice-normal-taxpayerIdentityNum").valS(cachedInvoice.normalTaxpayerIdentityNum);UIController.elecInvoiceCacheToBoxView(cachedInvoice);var defaultValue;if(cachedInvoice.vat!=null){$("#vatInvoice-companyName").valS(cachedInvoice.vat.companyName);$("#vatInvoice-taxpayerIdentityNum").valS(cachedInvoice.vat.taxpayerIdentityNum);$("#vatInvoice-registeredAddress").valS(cachedInvoice.vat.registeredAddress);$("#vatInvoice-registeredTelephone").valS(cachedInvoice.vat.registeredTelephone);$("#vatInvoice-depositBank").valS(cachedInvoice.vat.depositBank);$("#vatInvoice-bankAccount").valS(cachedInvoice.vat.bankAccount);$("#vatInvoice-consignee").valS(cachedInvoice.vat.consignee);$("#vatInvoice-zipcode").valS(cachedInvoice.vat.zipcode);$("#vatInvoice-address").valS(cachedInvoice.vat.address);$("#vatInvoice-mobile").valS(cachedInvoice.vat.mobile);defaultValue=cachedInvoice.vat.district;if(cachedInvoice.vat.street!=null&&cachedInvoice.vat.street!=""){defaultValue=cachedInvoice.vat.street}$("#myAddress-add-new-box").remove();$("#myAddress-edit-new-box").remove();if(defaultValue){ec.address.setValue(cachedInvoice.vat);ec.address.queryData(ec.address.parseUrl(tree_url,defaultValue),true,1,ec.address.getCitydistrict)}}$("#myAddress-msg").removeClass("icon-error");UIController.maskTab(cachedInvoice.shopCode);UIController.changeTab(cachedInvoice.shopCode,cachedInvoice.lastInvoiceType,cachedInvoice.lastInvoiceTitleType)},viewBoxToCache:function(shopCode){var invoiceCached=InvoiceManager.getInvoice(shopCode);if($("#invoice_click_1").hasClass("current")){invoiceCached.lastInvoiceType="1";if($("#invoiceTitle-normalPerson").hasClass("icon-radio")){invoiceCached.lastInvoiceTitleType="1"}if($("#invoiceTitle-normalCompany").hasClass("icon-radio")){if(!ec.form.validator($("#invoice-normal-form"),true)){return}invoiceCached.lastInvoiceTitleType="2";invoiceCached.normal=ec.order.invoice.optCompany($("#invoice-normal-company").val());invoiceCached.normalTaxpayerIdentityNum=$("#invoice-normal-taxpayerIdentityNum").val()}}if($("#invoice_click_2").hasClass("current")){invoiceCached.lastInvoiceType="2";if($("#invoiceTitle-elecPerson").hasClass("icon-radio")){invoiceCached.lastInvoiceTitleType="1";if(InvoiceManager.invoiceCfgList[shopCode]!=null){if(InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode!=null&&InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode.length>0){if(!ec.form.validator($("#invoice-electronic-form-person"),true)){return}if($("#elecEmailError-person").hasClass("eWayErro")){return}if($("#invoice-electronic-person-phone").val()!=null&&$("#invoice-electronic-person-phone").val()!=""){invoiceCached.electronicSendWayPhoneP=$("#invoice-electronic-person-phone").val()}else{invoiceCached.electronicSendWayPhoneP=""}if($("#invoice-electronic-email-person").val()!=null&&$("#invoice-electronic-email-person").val()!=""){invoiceCached.electronicSendWayEmailP=$("#invoice-electronic-email-person").val()}else{invoiceCached.electronicSendWayEmailP=""}}else{invoiceCached.electronicSendWayEmailU="";invoiceCached.electronicSendWayPhoneU="";invoiceCached.electronicSendWayEmailP="";invoiceCached.electronicSendWayPhoneP=""}}}if($("#invoiceTitle-elecCompany").hasClass("icon-radio")){if(!ec.form.validator($("#invoice-electronic-form"),true)){return}if(!ec.form.validator($("#invoice-electronic-NewSendWay-form"),true)){return}invoiceCached.lastInvoiceTitleType="2";invoiceCached.electronic=ec.order.invoice.optCompany($("#invoice-electronic-company").val());invoiceCached.electronicTaxpayerIdentityNum=$("#invoice-electronic-taxpayerIdentityNum").val();if(InvoiceManager.invoiceCfgList[shopCode]!=null){if(InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode!=null&&InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode.length>0){if(!ec.form.validator($("#invoice-electronic-form"),true)){return}if($("#elecEmailError-unit").hasClass("eWayErro")){return}if($("#invoice-electronic-unit-phone").val()!=null&&$("#invoice-electronic-unit-phone").val()!=""){invoiceCached.electronicSendWayPhoneU=$("#invoice-electronic-unit-phone").val()}else{invoiceCached.electronicSendWayPhoneU=""}if($("#invoice-electronic-email-unit").val()!=null&&$("#invoice-electronic-email-unit").val()!=""){invoiceCached.electronicSendWayEmailU=$("#invoice-electronic-email-unit").val()}else{invoiceCached.electronicSendWayEmailU=""}}else{invoiceCached.electronicSendWayEmailU="";invoiceCached.electronicSendWayPhoneU="";invoiceCached.electronicSendWayEmailP="";invoiceCached.electronicSendWayPhoneP=""}}}}if($("#invoice_click_0").hasClass("current")){invoiceCached.lastInvoiceType="0"}if($("#invoice_click_3").hasClass("current")){if(!ec.form.validator($("#vatinvoice-company-form"),true)){ec.order.invoice.popup.select(5);return}if(!ec.form.validator($("#vatinvoice-person-form"),true)){ec.order.invoice.popup.select(4);return}if(""!=$("input[name=provinceG]").val()&&""!=$("input[name=cityG]").val()&&""!=$("input[name=districtG]").val()){$("#vatInvoice-myAddress-error").removeClass("report-errors");$("#vatInvoice-myAddress-error").hide()}else{$("#vatInvoice-myAddress-error").addClass("report-errors");$("#vatInvoice-myAddress-error").text("请选择完整的地区信息");$("#vatInvoice-myAddress-error").show();return}invoiceCached.lastInvoiceType="3";invoiceCached.vat.taxpayerIdentityNum=$("#vatInvoice-taxpayerIdentityNum").val();invoiceCached.vat.registeredAddress=$("#vatInvoice-registeredAddress").val();invoiceCached.vat.registeredTelephone=$("#vatInvoice-registeredTelephone").val();invoiceCached.vat.depositBank=$("#vatInvoice-depositBank").val();invoiceCached.vat.bankAccount=$("#vatInvoice-bankAccount").val();invoiceCached.vat.companyName=ec.order.invoice.optCompany($("#vatInvoice-companyName").val());invoiceCached.vat.consignee=$("#vatInvoice-consignee").val();invoiceCached.vat.province=$("input[name=provinceG]").val();invoiceCached.vat.city=$("input[name=cityG]").val();invoiceCached.vat.district=$("input[name=districtG]").val();invoiceCached.vat.street=$("input[name=streetG]").val();invoiceCached.vat.address=$("#vatInvoice-address").val();invoiceCached.vat.mobile=$("#vatInvoice-mobile").val();invoiceCached.vat.zipcode=$("#vatInvoice-zipcode").val()}UIController.cacheToPageViewOne(invoiceCached);ec.order.invoice.popup.box.close();UcInterface.update2UC(invoiceCached)},elecInvoiceViewInfoToCache:function(shopCode){var invoiceCached=InvoiceManager.getInvoice(shopCode);if($("#invoice_click_2").hasClass("current")){invoiceCached.lastInvoiceType="2";if($("#invoiceTitle-elecPerson").hasClass("icon-radio")){invoiceCached.lastInvoiceTitleType="1";if(InvoiceManager.invoiceCfgList[shopCode]!=null){if(InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode!=null&&InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode.length>0){if($("#invoice-electronic-person-phone").val()!=null&&$("#invoice-electronic-person-phone").val()!=""){invoiceCached.electronicSendWayPhoneP=$("#invoice-electronic-person-phone").val();invoiceCached.electronicSendWayPhoneU=$("#invoice-electronic-person-phone").val()}else{invoiceCached.electronicSendWayPhoneP="";invoiceCached.electronicSendWayPhoneU=""}if($("#invoice-electronic-email-person").val()!=null&&$("#invoice-electronic-email-person").val()!=""){invoiceCached.electronicSendWayEmailP=$("#invoice-electronic-email-person").val();invoiceCached.electronicSendWayEmailU=$("#invoice-electronic-email-person").val()}else{invoiceCached.electronicSendWayEmailP="";invoiceCached.electronicSendWayEmailU=""}}else{invoiceCached.electronicSendWayEmailU="";invoiceCached.electronicSendWayPhoneU="";invoiceCached.electronicSendWayEmailP="";invoiceCached.electronicSendWayPhoneP=""}}}if($("#invoiceTitle-elecCompany").hasClass("icon-radio")){invoiceCached.lastInvoiceTitleType="2";invoiceCached.electronic=ec.order.invoice.optCompany($("#invoice-electronic-company").val());invoiceCached.electronicTaxpayerIdentityNum=$("#invoice-electronic-taxpayerIdentityNum").val();if(InvoiceManager.invoiceCfgList[shopCode]!=null){if(InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode!=null&&InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode.length>0){if($("#invoice-electronic-unit-phone").val()!=null&&$("#invoice-electronic-unit-phone").val()!=""){invoiceCached.electronicSendWayPhoneU=$("#invoice-electronic-unit-phone").val();invoiceCached.electronicSendWayPhoneP=$("#invoice-electronic-unit-phone").val()}else{invoiceCached.electronicSendWayPhoneU="";invoiceCached.electronicSendWayPhoneP=""}if($("#invoice-electronic-email-unit").val()!=null&&$("#invoice-electronic-email-unit").val()!=""){invoiceCached.electronicSendWayEmailU=$("#invoice-electronic-email-unit").val();invoiceCached.electronicSendWayEmailP=$("#invoice-electronic-email-unit").val()}else{invoiceCached.electronicSendWayEmailU="";invoiceCached.electronicSendWayEmailP=""}}else{invoiceCached.electronicSendWayEmailU="";invoiceCached.electronicSendWayPhoneU="";invoiceCached.electronicSendWayEmailP="";invoiceCached.electronicSendWayPhoneP=""}}}}},elecInvoiceCacheToBoxView:function(cachedInvoice){$("#invoice-electronic-company").valS(cachedInvoice.electronic);$("#invoice-electronic-taxpayerIdentityNum").valS(cachedInvoice.electronicTaxpayerIdentityNum);var invoiceCfg=InvoiceManager.invoiceCfgList[cachedInvoice.shopCode];if(invoiceCfg!=null){if(invoiceCfg.electronicReceiveMode!=null&&invoiceCfg.electronicReceiveMode.length>0){$("#invoice-electronic-person-phone").valS(cachedInvoice.electronicSendWayPhoneP);$("#invoice-electronic-email-person").valS(cachedInvoice.electronicSendWayEmailP);$("#invoice-electronic-unit-phone").valS(cachedInvoice.electronicSendWayPhoneU);$("#invoice-electronic-email-unit").valS(cachedInvoice.electronicSendWayEmailU);if(invoiceCfg.electronicReceiveModeStr.indexOf("P")<0){$("#invoice-electronic-person-phone").val("");$("#invoice-electronic-unit-phone").val("")}if(invoiceCfg.electronicReceiveModeStr.indexOf("E")<0){$("#invoice-electronic-email-person").val("");$("#invoice-electronic-email-unit").val("")}}else{$("#invoice-electronic-person-phone").val("");$("#invoice-electronic-unit-phone").val("");$("#invoice-electronic-email-person").val("");$("#invoice-electronic-email-unit").val("")}}},changeTitleType:function(type){switch(""+type){case"11":$("#invoice-normal-form").hide();$("#invoiceTitle-normalPerson").addClass("icon-radio");$("#invoiceTitle-normalCompany").removeClass("icon-radio");break;case"12":$("#invoice-normal-form").show();$("#invoiceTitle-normalPerson").removeClass("icon-radio");$("#invoiceTitle-normalCompany").addClass("icon-radio");break;case"21":if($("#order-shopCode").val()!="VMALL-HUAWEIDEVICE"){UIController.elecInvoiceViewInfoToCache($("#order-shopCode").val())}$("#invoice-electronic-form").hide();$("#invoiceTitle-elecPerson").addClass("icon-radio");$("#invoiceTitle-elecCompany").removeClass("icon-radio");if($("#order-shopCode").val()!="VMALL-HUAWEIDEVICE"){if(InvoiceManager.invoiceCfgList[$("#order-shopCode").val()]!=null){if(InvoiceManager.invoiceCfgList[$("#order-shopCode").val()].electronicReceiveModeStr.length>0){$("#sendWay-person").show();$("#showPhone-person-content").hide();$("#showEmail-person-content").hide();ec.order.newSendShow("P")}UIController.elecInvoiceCacheToBoxView(InvoiceManager.getInvoice($("#order-shopCode").val()));$("#elecPhoneError-person").html($("#elecPhoneError-unit").html());$("#elecEmailError-person").html($("#elecEmailError-unit").html())}}break;case"22":if($("#order-shopCode").val()!="VMALL-HUAWEIDEVICE"){UIController.elecInvoiceViewInfoToCache($("#order-shopCode").val())}$("#invoice-electronic-form").show();$("#invoiceTitle-elecPerson").removeClass("icon-radio");$("#invoiceTitle-elecCompany").addClass("icon-radio");if($("#order-shopCode").val()!="VMALL-HUAWEIDEVICE"){if(InvoiceManager.invoiceCfgList[$("#order-shopCode").val()]!=null){if(InvoiceManager.invoiceCfgList[$("#order-shopCode").val()].electronicReceiveModeStr.length>0){$("#sendWay-person").hide();$("#showEmail-unit-content").hide();$("#showPhone-unit-content").hide();ec.order.newSendShow("U")}UIController.elecInvoiceCacheToBoxView(InvoiceManager.getInvoice($("#order-shopCode").val()));$("#elecPhoneError-unit").html($("#elecPhoneError-person").html());$("#elecEmailError-unit").html($("#elecEmailError-person").html())}}break;case"0":$("#invoiceTitle-notuse").addClass("icon-radio");break}},cacheToPageViewOne:function(cached){if(!cached){return}if(InvoiceManager.isUneffective(cached.shopCode,cached.lastInvoiceType)){$("#invoice-info-type"+cached.shopCode).hide();$("#invoice-info-title"+cached.shopCode).hide();$("#invoiceEdit"+cached.shopCode).html("选择发票类型");return}switch(""+cached.lastInvoiceType){case"1":$("#invoice-info-type"+cached.shopCode).text("纸质普通发票");$("#order-titleType"+cached.shopCode).val("1");$("#invoice-info-title"+cached.shopCode).text("个人");$("#order-invoiceTitle"+cached.shopCode).val("个人");$("#order-taxpayerIdentityNum"+cached.shopCode).val("");if(cached.lastInvoiceTitleType=="2"){$("#invoice-info-title"+cached.shopCode).textS(cached.normal);$("#order-invoiceTitle"+cached.shopCode).valS(cached.normal);$("#order-taxpayerIdentityNum"+cached.shopCode).valS(cached.normalTaxpayerIdentityNum)}break;case"2":$("#invoice-info-type"+cached.shopCode).text("电子普通发票");$("#order-titleType"+cached.shopCode).val("50");$("#invoice-info-title"+cached.shopCode).text("个人");$("#order-invoiceTitle"+cached.shopCode).val("个人");$("#order-taxpayerIdentityNum"+cached.shopCode).val("");if(cached.lastInvoiceTitleType=="2"){$("#invoice-info-title"+cached.shopCode).textS(cached.electronic);$("#order-invoiceTitle"+cached.shopCode).valS(cached.electronic);$("#order-taxpayerIdentityNum"+cached.shopCode).valS(cached.electronicTaxpayerIdentityNum)}if(cached.lastInvoiceTitleType=="1"){if(cached.electronicSendWayPhoneP!=null){$("#order-SendWayPhone"+cached.shopCode).valS(cached.electronicSendWayPhoneP)}if(cached.electronicSendWayEmailP!=null){$("#order-SendWayEmail"+cached.shopCode).valS(cached.electronicSendWayEmailP)}}else{if(cached.electronicSendWayPhoneU!=null){$("#order-SendWayPhone"+cached.shopCode).valS(cached.electronicSendWayPhoneU)}if(cached.electronicSendWayEmailU!=null){$("#order-SendWayEmail"+cached.shopCode).valS(cached.electronicSendWayEmailU)}}break;case"0":$("#invoice-info-type"+cached.shopCode).text("不开发票");$("#invoice-info-title"+cached.shopCode).text("");$("#order-titleType"+cached.shopCode).val("0");$("#order-invoiceTitle"+cached.shopCode).val("");break;case"3":$("#invoice-info-type"+cached.shopCode).text("专用发票");$("#invoice-info-title"+cached.shopCode).textS(cached.vat.companyName);$("#order-titleType"+cached.shopCode).val("3");$("#order-invoiceTitle"+cached.shopCode).valS(cached.vat.companyName);$("#order-vatInvoiceJson"+cached.shopCode).valS(ec.lang.json.stringify(InvoiceManager.newVatInvoice(cached)));$("#order-vatInvoiceCompany"+cached.shopCode).valS(InvoiceManager.newVatInvoice(cached).companyName);$("#order-vatInvoiceDeliveryJson"+cached.shopCode).valS(ec.lang.json.stringify(InvoiceManager.newVatInvoiceDelivery(cached)));break}$("#invoice-info-type"+cached.shopCode).show();$("#invoice-info-title"+cached.shopCode).show();$("#invoiceEdit"+cached.shopCode).html("修改")},cacheToPageView:function(){var codes=InvoiceManager.shopCodeList;var cList=InvoiceManager.invoiceList;for(var i=0;i<codes.length;i++){var code=codes[i],cachedData=InvoiceManager.getInvoice(code);UIController.cacheToPageViewOne(cachedData);if(!cList[code].isMatch){$("#invoice-info-type"+code).hide();$("#invoice-info-title"+code).hide();$("#invoiceEdit"+code).html("选择发票类型")}}}};InvoiceManager={shopCodeList:[],invoiceList:{},userInvoiceList:{},orderInvoiceList:{},invoiceCfgList:{},getInvoice:function(shopCode){return InvoiceManager.invoiceList[shopCode]},newVatInvoice:function(cached){var vatInvoice={};vatInvoice.companyName=cached.vat.companyName;vatInvoice.taxpayerIdentityNum=cached.vat.taxpayerIdentityNum;vatInvoice.registeredAddress=cached.vat.registeredAddress;vatInvoice.registeredTelephone=cached.vat.registeredTelephone;vatInvoice.depositBank=cached.vat.depositBank;vatInvoice.bankAccount=cached.vat.bankAccount;return vatInvoice},newVatInvoiceDelivery:function(cached){var vatInvoiceDelivery={};vatInvoiceDelivery.consignee=cached.vat.consignee;vatInvoiceDelivery.mobile=cached.vat.mobile;vatInvoiceDelivery.zipCode=cached.vat.zipcode;vatInvoiceDelivery.provinceId=cached.vat.province;vatInvoiceDelivery.cityId=cached.vat.city;vatInvoiceDelivery.districtId=cached.vat.district;vatInvoiceDelivery.streetId=cached.vat.street;vatInvoiceDelivery.address=cached.vat.address;return vatInvoiceDelivery},isEffective:function(shopCode,invoiceType){var invoice=InvoiceManager.invoiceList[shopCode];if(!invoice||!invoice.effectiveList){return false}if(invoiceType==2){return invoice.effectiveList.indexOf("|50|")>=0}return invoice.effectiveList.indexOf("|"+invoiceType+"|")>=0},isUneffective:function(shopCode,invoiceType){var invoice=InvoiceManager.invoiceList[shopCode];if(!invoice||!invoice.uneffectiveList){return false}if(invoiceType==2){return invoice.uneffectiveList.indexOf("|50|")>=0}return invoice.uneffectiveList.indexOf("|"+invoiceType+"|")>=0},NoSelfShowMoreWay:function(shopCode,invoiceType){var invoice=InvoiceManager.invoiceList[shopCode];if(!invoice||!invoice.uneffectiveList){return false}},fromOrder:function(){InvoiceManager.shopCodeList=$("#order-shopCodes").val().split("|");for(var i=0;i<InvoiceManager.shopCodeList.length;i++){if(!InvoiceManager.shopCodeList[i]){InvoiceManager.shopCodeList.splice(i,1)}}var invoiceList=InvoiceManager.orderInvoiceList;var codeList=InvoiceManager.shopCodeList;for(var i=0;i<codeList.length;i++){var code=codeList[i];var titleType=$("#order-titleType"+code).val();titleType=titleType==50?2:titleType;invoiceList[code]={shopCode:code,defaultInvoiceType:titleType,effectiveList:"|"+$("#order-effectiveList"+code).val()+"|",uneffectiveList:"|"+$("#order-uneffectiveList"+code).val()+"|"}}},queryCfg:function(shopCode){if(InvoiceManager.invoiceCfgList[shopCode]){return}$.ajax({url:"/invoice/queryInvoiceCfg.json",dataType:"json",async:false,timeout:3e3,data:{shopCode:shopCode},success:function(json){if(json.invoiceConfig){InvoiceManager.invoiceCfgList[json.invoiceConfig.carrierCode]=json.invoiceConfig;if(json.invoiceConfig.carrierCode!="VMALL-HUAWEIDEVICE"){var sendWayList=json.invoiceConfig.electronicReceiveMode;for(var i=0;i<sendWayList.length;i++){if(sendWayList[i]=="P"){InvoiceManager.invoiceCfgList[json.invoiceConfig.carrierCode].isRequirePhoneCheck=true;document.getElementById("invoice-electronic-email-person").setAttribute("placeholder","请输入接收电子发票的电子邮箱（选填）");document.getElementById("invoice-electronic-email-unit").setAttribute("placeholder","请输入接收电子发票的电子邮箱（选填）")}if(sendWayList[i]=="E"){InvoiceManager.invoiceCfgList[json.invoiceConfig.carrierCode].isRequireEmailCheck=true}}}}}})},fromUC:function(){InvoiceManager.mergeInvoiceList();UIController.cacheToPageView();UcInterface.queryUC(InvoiceManager.shopCodeList,InvoiceManager.userInvoiceList,function(){InvoiceManager.mergeInvoiceList();UIController.cacheToPageView()})},mergeInvoiceList:function(){var codes=InvoiceManager.shopCodeList,cList=InvoiceManager.invoiceList,uList=InvoiceManager.userInvoiceList,oList=InvoiceManager.orderInvoiceList;for(var i=0;i<codes.length;i++){var shopCode=codes[i];cList[shopCode]=$.extend({vat:{}},uList[shopCode],oList[shopCode]);cList[shopCode].isNull=parseInt(cList[shopCode].lastInvoiceType)>=0?false:true;cList[shopCode].isMatch=cList[shopCode].lastInvoiceType==cList[shopCode].defaultInvoiceType;cList[shopCode].lastInvoiceType=cList[shopCode].defaultInvoiceType;cList[shopCode].lastInvoiceTitleType=cList[shopCode].isMatch?cList[shopCode].lastInvoiceTitleType:"1";cList[shopCode].isMatch=cList[shopCode].isNull||cList[shopCode].isMatch}},initialize:function(){InvoiceManager.fromOrder();InvoiceManager.fromUC()}};ec.ready(function(){InvoiceManager.initialize()});ec.order.invoice.checkEmailSuccess=function(type){var userEmailID;var $error;if(type==1){userEmailID=$("#invoice-electronic-email-person").val();$error=$("#elecEmailError-person")}else{userEmailID=$("#invoice-electronic-email-unit").val();$error=$("#elecEmailError-unit")}if(userEmailID!=""){var reg=/^(\w)+(\.\w+)*@(\w)+((\.[a-zA-Z]+)+)$/;var flag=reg.test(userEmailID);if(!flag){$error.text("邮箱格式不正确");if(!$error.hasClass("eWayErro")){$error.addClass("eWayErro")}return false}else{$error.text("");if($error.hasClass("eWayErro")){$error.removeClass("eWayErro")}return true}}if(userEmailID==""){$error.text("");if($error.hasClass("eWayErro")){$error.removeClass("eWayErro")}return true}};ec.order.newSendShow=function(type){var shopCode=$("#order-shopCode").val();var sendWayList=InvoiceManager.invoiceCfgList[shopCode].electronicReceiveMode;for(var i=0;i<sendWayList.length;i++){if(sendWayList[i]=="P"){if(type=="P"){$("#showPhone-person-content").show()}else{$("#showPhone-unit-content").show()}}else{if(type=="P"){$("#showEmail-person-content").show()}else{$("#showEmail-unit-content").show()}}}};ec.order.invoice.inputChange=function(){$("#invoice_next_step").attr("typePage","7")};ec.order.invoice.selectWhich=function(){if($("#invoice_next_step").attr("typePage")==7){ec.order.invoice.popup.select(7)}else{ec.order.invoice.popup.select(4)}};ec.order.invoice.guideToSpecialVat=function(type){var typeTemp;var taxNum;if(InvoiceManager.isUneffective($("#order-shopCode").val(),3)){return}if(!InvoiceManager.isEffective($("#order-shopCode").val(),"3")){return}if(type==1){typeTemp=$("#invoice-normal-taxpayerIdentityNum");taxNum=typeTemp.val();if(!ec.form.validator($("#invoice-normal-taxpayerIdentityNum"),true)){return}}else{typeTemp=$("#invoice-electronic-taxpayerIdentityNum");taxNum=typeTemp.val();if(!ec.form.validator($("#invoice-electronic-taxpayerIdentityNum"),true)){return}}setTimeout(function(){(new ec.ajax).post({url:"/invoice/queryTaxNum.json",data:{taxNum:taxNum},timeout:1e4,successFunction:function(json){if(json.success){if(json.msg!="noTips"){typeTemp.siblings().html(ec.autoEncodeAttr(json.msg));if(!typeTemp.siblings().hasClass("report-errors")){typeTemp.siblings().addClass("report-errors")}}}}})},300)};ec.order.invoice.getAllTaxNumber=function(){var tempVatNumber="";for(var i=0;i<InvoiceManager.shopCodeList.length;i++){if($("#order-titleType"+InvoiceManager.shopCodeList[i]).val()=="1"||$("#order-titleType"+InvoiceManager.shopCodeList[i]).val()=="2"||$("#order-titleType"+InvoiceManager.shopCodeList[i]).val()=="50"){if(!InvoiceManager.isUneffective(InvoiceManager.shopCodeList[i],3)&&InvoiceManager.isEffective(InvoiceManager.shopCodeList[i],"3")){if($("#order-taxpayerIdentityNum"+InvoiceManager.shopCodeList[i]).val()!=""&&$("#order-taxpayerIdentityNum"+InvoiceManager.shopCodeList[i]).val()!=null){tempVatNumber+=$("#order-taxpayerIdentityNum"+InvoiceManager.shopCodeList[i]).val()+"|"}}}}return tempVatNumber};