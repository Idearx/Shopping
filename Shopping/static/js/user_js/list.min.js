ec.pkg("ec.member.msg");
ec.load("ajax", {loadType: "lazy"});
ec.load("ec.pager");
ec.member.msg.pageNumber = 1;
ec.ready(function () {
    $("#li-msg").css("color", "#ca141d");
    $("#li-msg em").css("color", "#ca141d");
    $("#pathTitle").html("站内信");
    $("#ec_ui_confirm").click(function (event) {
        event = event || window.event;
        event.stopPropagation()
    });
    $(document).bind("click", function (e) {
        var e = e || window.event;
        var elem = e.target || e.srcElement;
        if (elem.innerHTML != "删除") {
            $("#ec_ui_confirm").hide()
        }
    })
});
ec.member.msg.load = function (page) {
    var msgUrl, message, methodType;
    if ($("#msgType").val() == "msg") {
        msgUrl = "/member/msg.json";
        methodType = "get";
        message = "对不起，您暂时没有站内信息！"
    } else {
        msgUrl = "/member/ineractMsg.json";
        message = "对不起，您暂时没有互动信息！";
        methodType = "post"
    }
    $.ajax({
        url: msgUrl,
        type: methodType,
        dataType: "json",
        data: {
            pageNumber: page.pageNumber,
            totalPage: page.pageCount,
            totalRow: page.recordCount,
            pageSize: page.pageSize
        },
        timeout: 1e4,
        error: function () {
            // alert("读取超时，请重试！")
        },
        success: function (json) {
            if ($("#msgType").val() == "msg") {
                if (!json.success) {
                    if (json.messageList == null && json.msg == null) {
                        json.msg = "当前登录已失效"
                    }
                    ec.showError(json);
                    return
                }
                var html = [], p;
                for (var i = 0; i < json.messageList.length; i++) {
                    p = json.messageList[i];
                    title = ec.autoEncodeAttr(p.title);
                    var divClass, aClass;
                    if ((p.type == "3" || p.type == "4") && p.receiveStatus == "0") {
                        html.push('<div class="list-group-item unread">')
                    } else {
                        html.push('<div class="list-group-item read">')
                    }
                    html.push('<table border="0" cellpadding="0" cellspacing="0"><tbody><tr>');
                    html.push('<td class="col-type"><i></i><span>');
                    if (p.type == "1") {
                        html.push("公告")
                    } else if (p.type == "2") {
                        html.push("通知")
                    } else if (p.type == "3") {
                        html.push("互动")
                    } else if (p.type == "4") {
                        html.push("评论")
                    } else {
                        html.push("其它")
                    }
                    html.push('</span></td><td class="col-title">');
                    if ((p.type == "3" || p.type == "4") && p.receiveStatus == "0") {
                        html.push('<a class="read" href="/member/msg-' + p.id + "?type=" + p.receiverId + '" title="' + title + '" target="_blank">')
                    } else {
                        html.push('<a href="/member/msg-' + p.id + "?type=" + p.receiverId + '" title="' + title + '" target="_blank">')
                    }
                    html.push(title);
                    html.push('</a></td><td class="col-date">');
                    html.push(ec.util.parseDate(p.sendtime).format("yyyy-MM-dd HH:mm:ss"));
                    html.push('</td><td class="col-operate">');
                    if (p.type == "3" || p.type == "4") {
                        html.push('<p><a class="del" href="javascript:;" onclick="ec.member.msg.deleteMsg(this,' + ec.encodeForJS(p.id) + ');" title="删除"><span>删除</span></a></p>')
                    }
                    html.push("</td></tr></tbody></table></div>")
                }
            } else {
                if (!json.success) {
                    if (json.Interacts == null && json.msg == null) {
                        json.msg = "当前登录已失效"
                    }
                    ec.showError(json);
                    return
                }
                var html = [], p;
                for (var i = 0; i < json.Interacts.length; i++) {
                    p = json.Interacts[i];
                    var str = JSON.parse(p.content.transHtmlAttribute());
                    title = ec.autoEncodeAttr(p.title);
                    var divClass, aClass;
                    if (p.receiveStatus == "0") {
                        html.push('<div class="list-group-item unread">')
                    } else {
                        html.push('<div class="list-group-item read">')
                    }
                    html.push('<table border="0" cellpadding="0" cellspacing="0"><tbody><tr>');
                    html.push('<td class="col-type"><i></i><span>');
                    html.push(title);
                    html.push('</span></td><td class="col-title">');
                    html.push('<a class="read" onclick="ec.member.msg.updateIneractMsg(this,' + ec.encodeForJS(p.id) + ',1);"  href="/product/viewReply/' + str.msg.pid + "/" + str.msg.rmsId + "?t=" + (new Date).getTime() + '" target="_blank">');
                    html.push(ec.autoEncodeAttr(str.msg.content));
                    html.push('</a></td><td class="col-date">');
                    html.push(ec.util.parseDate(p.createTime).format("yyyy-MM-dd HH:mm:ss"));
                    html.push('</td><td class="col-operate">');
                    html.push('<p><a class="del" href="javascript:;" onclick="ec.member.msg.updateIneractMsg(this,' + ec.encodeForJS(p.id) + ',2);" title="删除"><span>删除</span></a></p>');
                    html.push("</td></tr></tbody></table></div>")
                }
            }
            $("#list-group").html(html.join(""));
            if (json.page.totalPage < json.page.pageNumber) {
                var data = {pageNumber: json.page.totalPage};
                ec.member.msg.load(data);
                return
            }
            if (json.page.totalRow == 0) {
                $("#list-group").html('<div class="inform-empty-area">' + message + "</div>").removeClass("inform-list");
                ec.member.msg.renderPage(json.page);
                return
            } else {
                ec.member.msg.renderPage(json.page)
            }
            ec.ui.scrollTo("#list-group-title")
        }
    })
};
ec.member.msg.check = function (obj, num) {
    if ($(obj).parent("li").hasClass("current")) {
        return
    }
    $("#msgType").valS(num);
    var pamar = {pageNumber: 1};
    ec.member.msg.load(pamar);
    $(obj).parent("li").addClass("current").siblings().removeClass("current")
};
ec.member.msg.renderPage = function (page) {
    if (page.totalPage <= 1) {
        $(".list-group-page").hide();
        return
    } else {
        $(".list-group-page").show()
    }
    ec.member.msg.pageNumber = page.pageNumber;
    $("#list-pager").pager({
        pageNumber: page.pageNumber,
        pageCount: page.totalPage,
        pageSize: 10,
        text: {first: "|&lt;", pre: "&lt", next: "&gt;", last: "&gt;|"},
        item: ["first", "pre", "qpage", "next", "last", "quickPager"],
        callBack: ec.member.msg.load
    })
};
ec.member.msg.deleteMsg = function (dom, mid) {
    if (!ec.ui.confirm(dom, "您确认要删除吗？")) {
        return
    }
    ec.loadCsrfToken(function () {
        $.ajax({
            type: "POST",
            url: "/member/msg/del-" + mid + ".json",
            dataType: "json",
            timeout: 1e4,
            beforeSend: function (xhr) {
                ec.ui.loading.show()
            },
            success: function (json) {
                ec.ui.loading.hide();
                if (!json.success) {
                    if (JSON.stringify(json) == "{}") {
                        json.msg = "当前登录已失效"
                    }
                    ec.showError(json);
                    return
                }
                var data = {pageNumber: ec.member.msg.pageNumber};
                ec.member.msg.load(data);
                if (json.isRead == 0) {
                    var oldCount = ec.util.cookie.get("vmallMyCenterMsg");
                    var newCount = oldCount - 1;
                    if (newCount > 0) {
                        $("#li-msg em").textS(newCount);
                        $("#top-newMsgCount").html(newCount || 0)
                    } else {
                        $("#li-msg em").text("")
                    }
                    ec.util.cookie.set("vmallMyCenterMsg", newCount)
                }
            },
            error: function () {
                // alert("读取超时，请重试！")
            }
        })
    })
};
ec.member.msg.getUnReadMessageCount = function () {
    $.ajax({
        url: "/member/msg/unRead.json", timeout: 1e4, dataType: "json", success: function (json) {
            if (!json.success) {
                return
            }
            var msgcount = json.count;
            if (msgcount > 0) {
                $("#li-msg em").textS(msgcount);
                $("#top-newMsgCount").html(msgcount || 0)
            }
            ec.util.cookie.set("vmallMyCenterMsg", msgcount)
        }
    })
};
ec.member.msg.updateIneractMsg = function (dom, mid, isRead) {
    if (isRead == 2) {
        if (!ec.ui.confirm(dom, "您确认要删除吗？")) {
            return
        }
    }
    ec.loadCsrfToken(function () {
        $.ajax({
            type: "POST",
            url: "/member/ineractMsg/update-" + mid + ".json?isRead=" + isRead,
            dataType: "json",
            timeout: 1e4,
            beforeSend: function (xhr) {
                ec.ui.loading.show()
            },
            success: function (json) {
                ec.ui.loading.hide();
                if (!json.success) {
                    if (JSON.stringify(json) == "{}") {
                        json.msg = "当前登录已失效"
                    }
                    ec.showError(json);
                    return
                }
                var data = {pageNumber: ec.member.msg.pageNumber};
                ec.member.msg.load(data);
                if (json.isRead == 0) {
                    var oldCount = ec.util.cookie.get("vmallMyCenterMsg");
                    var newCount = oldCount - 1;
                    if (newCount > 0) {
                        $("#li-msg em").textS(newCount);
                        $("#top-newMsgCount").html(newCount || 0)
                    } else {
                        $("#li-msg em").text("")
                    }
                    ec.util.cookie.set("vmallMyCenterMsg", newCount)
                }
            },
            error: function () {
                alert("读取超时，请重试！")
            }
        })
    })
};
ec.ready(function () {
    ec.member.msg.getUnReadMessageCount()
});